# 反派逆袭系统 - 角色卡分享部署指南

## 🎯 目标

实现用户通过**导入一个角色卡 JSON 文件**即可开始游戏，无需任何手动安装。

---

## 📋 部署步骤（开发者）

### 步骤 1：安装依赖

```bash
cd villain-game-app
npm install
```

### 步骤 2：本地测试构建

```bash
npm run build
```

这会在 `dist/` 目录生成单文件 HTML（包含所有 JS、CSS）。

**验证**：
- 检查 `dist/index.html` 是否存在
- 文件大小应该在 100KB - 500KB 之间
- 在浏览器中打开 `dist/index.html`，应该能看到游戏界面

### 步骤 3：配置 Cloudflare Pages

1. **注册 Cloudflare 账户**
   - 访问 https://dash.cloudflare.com/
   - 创建免费账户

2. **创建 Pages 项目**
   - 点击 "Pages" > "Create a project"
   - 选择 "Connect to Git"（可选）或 "Direct Upload"

3. **获取 API Token**
   - 访问 https://dash.cloudflare.com/profile/api-tokens
   - 点击 "Create Token"
   - 选择 "Edit Cloudflare Workers" 模板
   - 复制生成的 Token

4. **获取 Account ID**
   - 在 Cloudflare Dashboard 右侧可以找到
   - 格式：32位十六进制字符串

5. **配置 GitHub Secrets**
   - 打开你的 GitHub 仓库
   - Settings > Secrets and variables > Actions
   - 添加两个 secrets：
     - `CLOUDFLARE_API_TOKEN`：粘贴你的 API Token
     - `CLOUDFLARE_ACCOUNT_ID`：粘贴你的 Account ID

### 步骤 4：推送代码触发部署

```bash
git add .
git commit -m "配置角色卡分享部署"
git push origin main
```

GitHub Actions 会自动：
1. 安装依赖
2. 构建单文件 HTML
3. 部署到 Cloudflare Pages

**查看部署状态**：
- GitHub 仓库 > Actions 标签
- 等待构建完成（约 2-5 分钟）

### 步骤 5：获取部署 URL

部署完成后，Cloudflare 会提供一个 URL：
- 格式：`https://villain-game.pages.dev`
- 或自定义域名：`https://你的域名.com`

### 步骤 6：更新角色卡模板

编辑 `角色卡-反派逆袭系统.json`：

```json
{
  "character_book": {
    "entries": [
      {
        "keys": ["游戏界面"],
        "content": "<iframe id=\"villain-game-frame\" src=\"https://你的实际URL.pages.dev/index.html\" ... ></iframe>",
        ...
      }
    ]
  }
}
```

将 `https://你的实际URL.pages.dev/index.html` 替换为你的实际部署 URL。

### 步骤 7：分享角色卡

将更新后的 `角色卡-反派逆袭系统.json` 分享给用户。

---

## 👥 使用步骤（用户）

### 超级简单的 3 步

1. **下载角色卡**
   - 获得 `角色卡-反派逆袭系统.json` 文件

2. **导入到 SillyTavern**
   - 打开 SillyTavern
   - 点击角色管理
   - 导入角色卡 JSON 文件

3. **开始游戏**
   - 选择导入的"反派逆袭系统"角色
   - 游戏界面自动出现在右上角
   - 直接开始玩！

**无需任何额外安装！**

---

## 🔍 工作原理

### 技术架构

```
用户导入角色卡
    ↓
角色卡包含世界书条目（iframe 代码）
    ↓
酒馆加载角色卡时自动加载 iframe
    ↓
iframe 从 Cloudflare Pages 加载单文件 HTML
    ↓
游戏在 iframe 中运行
    ↓
直接访问 window.TavernHelper（全局注入）
    ↓
与 AI 实时交互！
```

### 关键技术点

1. **单文件打包**（Webpack）
   - HTML + CSS + JS 全部内联
   - 无需额外资源文件
   - 快速加载

2. **Cloudflare Pages**
   - 全球 CDN 加速
   - 自动 HTTPS
   - 免费且稳定

3. **世界书集成**
   - iframe 代码嵌入世界书条目
   - 关键词触发自动显示
   - 无缝集成到对话流程

4. **TavernHelper API**
   - 酒馆全局注入到 iframe
   - 无跨域问题
   - 直接 `window.TavernHelper.generate()`

---

## ⚙️ 自定义配置

### 调整游戏界面位置和大小

编辑角色卡中的 iframe 样式：

```html
<iframe
    src="..."
    style="
        position: fixed;
        top: 20px;        /* 距离顶部 */
        right: 20px;      /* 距离右侧 */
        width: 1200px;    /* 宽度 */
        height: 800px;    /* 高度 */
        ...
    ">
</iframe>
```

**常用配置**：

| 配置 | 描述 | 示例 |
|-----|------|------|
| **右上角** | `top: 20px; right: 20px;` | 默认 |
| **左上角** | `top: 20px; left: 20px;` | 切换到左侧 |
| **居中** | `top: 50%; left: 50%; transform: translate(-50%, -50%);` | 屏幕中央 |
| **紧凑模式** | `width: 900px; height: 700px;` | 更小的界面 |
| **全屏** | `width: 95vw; height: 95vh;` | 接近全屏 |

### 触发关键词

编辑角色卡中的 `keys` 字段：

```json
{
  "keys": ["游戏界面", "反派系统", "状态", "界面"],
  ...
}
```

当对话中包含这些关键词时，iframe 会自动加载。

---

## 🐛 故障排除

### 问题 1：游戏界面不显示

**可能原因**：
- iframe URL 错误
- Cloudflare Pages 部署失败
- 浏览器阻止了 iframe

**解决方法**：
```bash
# 1. 检查 Cloudflare 部署状态
访问 Cloudflare Dashboard > Pages > 你的项目

# 2. 测试 URL 是否可访问
在浏览器中直接打开 iframe 的 src URL

# 3. 检查浏览器控制台
按 F12 查看是否有错误信息
```

### 问题 2：TavernHelper 未找到

**症状**：
```
⚠ 当前为演示模式（TavernHelper 不可用）
```

**可能原因**：
- 不在 SillyTavern 环境中运行
- TavernHelper 扩展未安装

**解决方法**：
1. 确认在 SillyTavern 中打开
2. 检查 TavernHelper 扩展是否启用
3. 重启 SillyTavern

### 问题 3：AI 不回复

**可能原因**：
- API 配置错误
- 模型选择问题
- 提示词过长

**解决方法**：
```bash
# 1. 检查 AI API 配置
SillyTavern > Settings > AI API

# 2. 检查浏览器控制台
查看详细错误信息

# 3. 测试基础对话
在酒馆中先测试普通对话是否正常
```

### 问题 4：部署失败

**GitHub Actions 报错**：

```bash
# 查看错误日志
GitHub 仓库 > Actions > 失败的 workflow > 点击查看详情

# 常见错误：
# - npm install 失败 → 检查 package.json
# - build 失败 → 本地测试 npm run build
# - Cloudflare API Token 无效 → 重新生成 Token
```

---

## 📊 性能优化

### 1. 减小打包体积

编辑 `webpack.config.js`：

```javascript
optimization: {
  minimize: true,
  minimizer: [
    new TerserPlugin({
      terserOptions: {
        compress: {
          drop_console: true, // 移除 console.log
        },
      },
    }),
  ],
},
```

### 2. 启用缓存

Cloudflare Pages 自动启用全球 CDN 缓存，无需额外配置。

### 3. 代码拆分（可选）

如果单文件过大（> 1MB），可以考虑拆分：

```javascript
optimization: {
  splitChunks: {
    chunks: 'all',
  },
},
```

但这会导致多个文件，需要调整 Cloudflare 部署配置。

---

## 🚀 进阶功能

### 自动更新

用户无需重新下载角色卡！

1. 开发者推送新版本代码
2. GitHub Actions 自动部署
3. 用户刷新页面即可获得最新版本

### 版本管理

在 `game.js` 中添加版本号：

```javascript
const GAME_VERSION = '1.0.0';
console.log(`反派逆袭系统 v${GAME_VERSION}`);
```

### 多环境部署

创建不同的分支：
- `main` → 生产环境（Cloudflare Pages）
- `dev` → 开发环境（GitHub Pages）

---

## 📚 相关资源

- [完整技术方案文档](./通过角色卡分享方案.md)
- [跨域问题分析](./跨域解决方案分析.md)
- [Cloudflare Pages 文档](https://developers.cloudflare.com/pages/)
- [SillyTavern 文档](https://docs.sillytavern.app/)

---

## ✅ 检查清单

### 开发者部署检查

- [ ] 已安装 Node.js 和 npm
- [ ] 已运行 `npm install`
- [ ] 本地构建成功（`npm run build`）
- [ ] 已创建 Cloudflare 账户
- [ ] 已获取 API Token 和 Account ID
- [ ] 已配置 GitHub Secrets
- [ ] 代码已推送到 GitHub
- [ ] GitHub Actions 构建成功
- [ ] 获得 Cloudflare Pages URL
- [ ] 已更新角色卡模板中的 URL
- [ ] 角色卡 JSON 文件可分享

### 用户使用检查

- [ ] 已下载角色卡 JSON 文件
- [ ] SillyTavern 正常运行
- [ ] 成功导入角色卡
- [ ] 游戏界面正常显示
- [ ] TavernHelper API 可用
- [ ] AI 对话正常工作
- [ ] 游戏状态更新正常

---

生成时间：2025-01-06
作者：Claude (Sonnet 4.5)
