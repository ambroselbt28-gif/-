<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>反派逆袭系统指南 状态</title>
    <style>
        :root {
            --primary: #4f6ef7;
            --accent-rose: #ff6b9d;
            --accent-teal: #4ecdc4;
            --accent-lilac: #a29bfe;
            --surface: #f9f9fd;
            --surface-strong: #ffffff;
            --border: rgba(79, 110, 247, 0.12);
            --text-main: #2f3545;
            --text-muted: #6f7390;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: "Microsoft YaHei", "PingFang SC", "Hiragino Sans GB", sans-serif;
            background: transparent;
            color: var(--text-main);
            padding: 14px;
        }
        .status-card {
            max-width: 960px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.96);
            border-radius: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 18px 40px rgba(79, 110, 247, 0.12);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .metric-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 16px;
        }
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .metric-label {
            font-weight: bold;
            color: var(--text-main);
        }
        .metric-value {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary);
        }
        .progress-bar-container {
            width: 100%;
            background-color: var(--border);
            border-radius: 8px;
            height: 8px;
            overflow: hidden;
        }
        .progress-bar-value {
            height: 100%;
            background-color: var(--primary);
            border-radius: 8px;
            transition: width 0.5s ease-in-out;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        .info-card {
            background: var(--surface);
            padding: 12px;
            border-radius: 12px;
        }
        .info-label {
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
            color: var(--text-main);
        }
        .info-value {
            color: var(--text-muted);
        }
        .info-text {
            color: var(--text-muted);
            font-size: 0.9em;
            margin-top: 4px;
        }
        .panel-title {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            user-select: none;
            font-weight: bold;
            font-size: 1.1em;
            color: var(--text-main);
        }
        .panel-title::before {
            content: '▶';
            font-size: 0.8em;
            transition: transform 0.2s ease-in-out;
            color: var(--primary);
        }
        details[open] > summary.panel-title::before {
            transform: rotate(90deg);
        }
        summary {
            list-style: none;
        }
        summary::-webkit-details-marker {
            display: none;
        }
        .panel-block .info-grid, .panel-block .task-list {
            margin-top: 10px;
        }
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .task-item {
            background: var(--surface);
            padding: 12px;
            border-radius: 12px;
        }
        .task-header {
            font-weight: bold;
            margin-bottom: 4px;
        }
        .task-desc {
            color: var(--text-muted);
            font-size: 0.9em;
        }
        .error-tip {
            color: var(--accent-rose);
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
<div class="status-card" id="status-card">
    <details class="panel-block" open>
        <summary class="panel-title">玩家信息</summary>
        <div class="info-grid">
            <div class="info-card">
                <span class="info-label">境界</span>
                <span class="info-value" id="jingjie">N/A</span>
            </div>
            <div class="info-card">
                <span class="info-label">当前时间</span>
                <span class="info-value" id="current-time">N/A</span>
            </div>
        </div>
    </details>
    <div class="metric-card">
        <div class="metric-header">
            <span class="metric-label">反派值</span>
            <span class="metric-value">
                <span id="fanpaizhi">0</span>
            </span>
        </div>
        <div class="progress-bar-container">
            <div id="fanpaizhi-bar" class="progress-bar-value" style="width: 0%;"></div>
        </div>
    </div>
    <details class="panel-block" open>
        <summary class="panel-title">背包</summary>
        <div class="info-grid">
            <div class="info-card">
                <span class="info-label">拥有物品</span>
                <span class="info-value" id="wupin">N/A</span>
            </div>
            <div class="info-card">
                <span class="info-label">拥有技能</span>
                <span class="info-value" id="jineng">N/A</span>
            </div>
        </div>
    </details>
    <details class="panel-block" id="tianmingzhujue-panel" open>
        <summary class="panel-title">天命主角</summary>
        <div id="tianmingzhujue-list" class="info-grid"></div>
    </details>
    <details class="panel-block" id="nvxingjuese-panel" open>
        <summary class="panel-title">女性角色</summary>
        <div id="nvxingjuese-list" class="info-grid"></div>
    </details>
    <details class="panel-block" open>
        <summary class="panel-title">当前任务</summary>
        <div class="task-list">
            <div class="task-item">
                <div class="task-header">
                    <span class="task-name" id="task-name">N/A</span>
                </div>
                <p class="task-desc" id="task-reward">N/A</p>
                <p class="task-desc" id="task-deadline">N/A</p>
            </div>
        </div>
    </details>
</div>

<script>
    function updateFanpaiStatusBar(data) {
        if (!data) { return; }

        function getValue(path, defaultValue = 'N/A') {
            const keys = path.split('.');
            let current = data;
            for (const key of keys) {
                if (current === null || typeof current !== 'object') return defaultValue;
                current = current[key];
            }
            if (current === undefined || current === null) return defaultValue;
            let value = Array.isArray(current) ? current[0] : current;
            return value !== undefined && value !== null ? value : defaultValue;
        }

        function updateProgressBar(barId, valueId, rawValue, max) {
            const progressBar = document.getElementById(barId);
            const valueDisplay = document.getElementById(valueId);
            if (!progressBar || !valueDisplay) return;
            const numericValue = parseFloat(rawValue);
            valueDisplay.innerText = isNaN(numericValue) ? (rawValue || 0) : numericValue;
            if (!isNaN(numericValue) && max > 0) {
                const percentage = (numericValue / max) * 100;
                progressBar.style.width = `${Math.min(percentage, 100)}%`;
            } else {
                progressBar.style.width = '0%';
            }
        }

        document.getElementById('jingjie').innerText = getValue('玩家.境界');
        const timeValue = getValue('世界.时间');
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            const date = new Date(timeValue);
            timeElement.innerText = !isNaN(date.getTime()) 
                ? date.toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })
                : timeValue;
        }
        updateProgressBar('fanpaizhi-bar', 'fanpaizhi', getValue('玩家.反派值', 0), 100000);
        
        // Handle semi-colon delimited strings for arrays
        const itemsRaw = getValue('玩家.当前拥有的物品', '无');
        document.getElementById('wupin').innerText = (typeof itemsRaw === 'string' && itemsRaw) ? itemsRaw.split(';').join(', ') : '无';
        
        const skillsRaw = getValue('玩家.当前拥有的技能', '无');
        document.getElementById('jineng').innerText = (typeof skillsRaw === 'string' && skillsRaw) ? skillsRaw.split(';').join(', ') : '无';

        const tianmingzhujueContainer = document.getElementById('tianmingzhujue-list');
        const tianmingzhujueData = data.天命主角 || {};
        tianmingzhujueContainer.innerHTML = '';
        if (Object.keys(tianmingzhujueData).length > 0) {
             Object.entries(tianmingzhujueData).forEach(([name, details]) => {
                if (name === '$meta') return;
                const qiyun = Array.isArray(details.气运值) ? details.气运值[0] : (details.气运值 || 0);
                const liupai = Array.isArray(details.流派) ? details.流派[0] : (details.流派 || '无');
                tianmingzhujueContainer.innerHTML += `
                    <div class="info-card">
                        <span class="info-label">${name}</span>
                        <span class="info-value">气运: ${qiyun} | 流派: ${liupai}</span>
                    </div>`;
            });
        }

        const nvxingjueseContainer = document.getElementById('nvxingjuese-list');
        const interactingCharsRaw = getValue('世界.当前互动角色', '');
        let interactingChars = [];

        if (typeof interactingCharsRaw === 'string' && interactingCharsRaw.length > 0) {
            interactingChars = interactingCharsRaw.split(';');
        } else if (Array.isArray(interactingCharsRaw)) {
            // Fallback for any old data that might still be an array
            interactingChars = interactingCharsRaw;
        }
        
        const allFemaleCharacters = data.女性角色 || {};
        nvxingjueseContainer.innerHTML = '';
        
        if (Array.isArray(interactingChars) && interactingChars.length > 0) {
            const cardsHtml = interactingChars.map(name => {
                const charInfo = allFemaleCharacters[name];
                if (charInfo) {
                    const guanxi = Array.isArray(charInfo.与主角关系) ? charInfo.与主角关系[0] : (charInfo.与主角关系 || '无');
                    const haogandu = Array.isArray(charInfo.好感度) ? charInfo.好感度[0] : (charInfo.好感度 || 0);
                    const zhuangtai = Array.isArray(charInfo.身体状态) ? charInfo.身体状态[0] : (charInfo.身体状态 || '无');
                    return `
                        <div class="info-card">
                            <span class="info-label">${name}</span>
                            <span class="info-value">关系: ${guanxi} | 好感度: ${haogandu}</span>
                            <p class="info-text">身体状态: ${zhuangtai}</p>
                        </div>`;
                }
                return '';
            }).join('');
            nvxingjueseContainer.innerHTML = cardsHtml;
        }

        if(nvxingjueseContainer.innerHTML === ''){
             nvxingjueseContainer.innerHTML = '<div class="info-card"><span class="info-label" style="text-align:center;">当前无核心互动的女性角色</span></div>';
        }

        document.getElementById('task-name').innerText = getValue('当前任务.任务内容');
        document.getElementById('task-reward').innerText = `奖励: ${getValue('当前任务.任务奖励')}`;
        document.getElementById('task-deadline').innerText = `时限: ${getValue('当前任务.任务时限')}`;
    }

    function initFanpaiStatusBar() {
        let attempts = 0;
        const maxAttempts = 12;
        const interval = 250;

        function fetchData() {
            attempts++;
            try {
                if (typeof getChatMessages === 'function' && typeof getCurrentMessageId === 'function') {
                    const messages = getChatMessages(getCurrentMessageId());
                    if (messages && messages.length > 0) {
                        const lastMessage = messages[messages.length - 1];
                        if (lastMessage?.data?.stat_data) {
                            updateFanpaiStatusBar(lastMessage.data.stat_data);
                            return; 
                        }
                    }
                }
            } catch (error) {
                console.error("状态栏数据获取失败（尝试次数 " + attempts + ")：", error);
            }

            if (attempts < maxAttempts) {
                setTimeout(fetchData, interval);
            }
            else {
                const container = document.getElementById('status-card');
                if (container) {
                    container.innerHTML = '<div class="error-tip">错误：无法加载状态数据。请在发送一条消息后重试。</div>';
                }
            }
        }
        setTimeout(fetchData, 150);
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initFanpaiStatusBar);
    } else {
        initFanpaiStatusBar();
    }
</script>
</body>
</html>