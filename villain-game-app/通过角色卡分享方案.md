# åæ´¾é€†è¢­ç³»ç»Ÿ - é€šè¿‡è§’è‰²å¡åˆ†äº«å®Œæ•´æ–¹æ¡ˆ

åŸºäº GoblinGame çš„æˆåŠŸç»éªŒï¼Œå®ç°"æ— éœ€å®‰è£…ã€é€šè¿‡è§’è‰²å¡åˆ†äº«"çš„å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆã€‚

## æ ¸å¿ƒå‘ç°

### âœ… GoblinGame æˆåŠŸçš„å…³é”®

1. **iframe å¯ä»¥è®¿é—® `window.TavernHelper`**ï¼ˆä¸æ˜¯ `parent.TavernHelper`ï¼‰
2. **å•æ–‡ä»¶ HTML éƒ¨ç½²**ï¼ˆæ‰€æœ‰èµ„æºå†…è”ï¼‰
3. **äº‘ç«¯ CDN æ‰˜ç®¡**ï¼ˆCloudflare Pagesï¼‰
4. **è§’è‰²å¡åªéœ€ä¸€è¡Œ iframe ä»£ç **

### âŒ ä½ çš„å½“å‰é—®é¢˜

- GitHub Pages çš„ **https** åŸŸå â‰  SillyTavern çš„ **http://localhost**
- è·¨åŸŸç­–ç•¥é˜»æ­¢è®¿é—® `parent.TavernHelper`
- **ä½†æ˜¯**ï¼šiframe å†…éƒ¨åº”è¯¥èƒ½ç›´æ¥è®¿é—® `window.TavernHelper`ï¼ˆè¿™æ˜¯å…¨å±€å¯¹è±¡ï¼‰

## ğŸ¯ å®Œæ•´è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆæ¶æ„

```
ç”¨æˆ·æ“ä½œï¼š
1. å¯¼å…¥è§’è‰²å¡ï¼ˆåŒ…å« iframe ä»£ç ï¼‰
2. é…’é¦†åŠ è½½ iframe -> ä» Cloudflare Pages åŠ è½½å•æ–‡ä»¶ HTML
3. æ¸¸æˆåœ¨ iframe ä¸­è¿è¡Œ
4. ç›´æ¥ä½¿ç”¨ window.TavernHelper ä¸ AI äº¤äº’

æŠ€æœ¯æ ˆï¼š
- Webpack 5ï¼ˆæ‰“åŒ…æˆå•æ–‡ä»¶ï¼‰
- GitHub Actionsï¼ˆè‡ªåŠ¨åŒ–æ„å»ºï¼‰
- Cloudflare Pagesï¼ˆå…¨çƒ CDNï¼‰
- Vue 3ï¼ˆå¯é€‰ï¼Œä¿ç•™åŸç”Ÿ JS ä¹Ÿå¯ä»¥ï¼‰
```

---

## ğŸ“ å®æ–½æ­¥éª¤

### æ­¥éª¤ 1ï¼šä¿®æ”¹ TavernHelper è®¿é—®æ–¹å¼

**å½“å‰ä»£ç é—®é¢˜**ï¼ˆgame.js:486ï¼‰ï¼š
```javascript
// âŒ é”™è¯¯ï¼šå°è¯•ä» parent è®¿é—®ï¼ˆè·¨åŸŸï¼‰
if (typeof parent.TavernHelper !== 'undefined') {
    window.TavernHelper = parent.TavernHelper;
}
```

**æ­£ç¡®æ–¹å¼**ï¼ˆå‚è€ƒ GoblinGameï¼‰ï¼š
```javascript
// âœ… æ­£ç¡®ï¼šç›´æ¥ä»å…¨å±€ä½œç”¨åŸŸè®¿é—®
if (typeof window.TavernHelper !== 'undefined' && window.TavernHelper.generate) {
    // TavernHelper å·²æ³¨å…¥åˆ° iframe çš„å…¨å±€ä½œç”¨åŸŸ
    await window.TavernHelper.generate({ ... });
}
```

**å…³é”®ç†è§£**ï¼š
- TavernHelper æ˜¯é…’é¦†**å…¨å±€æ³¨å…¥**çš„å¯¹è±¡
- åœ¨ iframe å†…ï¼Œå®ƒä¼šè‡ªåŠ¨å‡ºç°åœ¨ `window` å¯¹è±¡ä¸Š
- **ä¸éœ€è¦**ä» parent è·å–
- **ä¸éœ€è¦**æ‹…å¿ƒè·¨åŸŸé—®é¢˜

---

### æ­¥éª¤ 2ï¼šåˆ›å»º Webpack é…ç½®

åˆ›å»º `webpack.config.js`ï¼š

```javascript
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const HtmlInlineScriptPlugin = require('html-inline-script-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');
const HTMLInlineCSSWebpackPlugin = require('html-inline-css-webpack-plugin').default;

module.exports = {
    mode: 'production',
    entry: './game.js',
    output: {
        path: path.resolve(__dirname, 'dist'),
        filename: 'bundle.js',
        clean: true
    },
    module: {
        rules: [
            {
                test: /\.css$/,
                use: [MiniCssExtractPlugin.loader, 'css-loader']
            },
            {
                test: /\.ya?ml$/,
                type: 'asset/source'
            }
        ]
    },
    plugins: [
        new HtmlWebpackPlugin({
            template: './index.html',
            filename: 'index.html',
            inject: 'body'
        }),
        new MiniCssExtractPlugin({
            filename: 'style.css'
        }),
        new HtmlInlineScriptPlugin(), // å†…è”æ‰€æœ‰ JS
        new HTMLInlineCSSWebpackPlugin() // å†…è”æ‰€æœ‰ CSS
    ],
    optimization: {
        minimize: true
    }
};
```

**å®‰è£…ä¾èµ–**ï¼š
```bash
npm init -y
npm install --save-dev webpack webpack-cli html-webpack-plugin html-inline-script-webpack-plugin mini-css-extract-plugin html-inline-css-webpack-plugin css-loader
```

---

### æ­¥éª¤ 3ï¼šé…ç½® GitHub Actions è‡ªåŠ¨éƒ¨ç½²

åˆ›å»º `.github/workflows/deploy-cloudflare.yml`ï¼š

```yaml
name: Deploy to Cloudflare Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: villain-game-app
        run: npm install

      - name: Build
        working-directory: villain-game-app
        run: npm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: 'villain-game'
          directory: villain-game-app/dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
```

**é…ç½® Cloudflare**ï¼š
1. ç™»å½• Cloudflare Dashboard
2. åˆ›å»º Pages é¡¹ç›®
3. è·å– API Token å’Œ Account ID
4. åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­æ·»åŠ  Secretsï¼š
   - `CLOUDFLARE_API_TOKEN`
   - `CLOUDFLARE_ACCOUNT_ID`

---

### æ­¥éª¤ 4ï¼šä¿®æ”¹ package.json

åœ¨ `villain-game-app/package.json` ä¸­æ·»åŠ ï¼š

```json
{
  "name": "villain-game",
  "version": "1.0.0",
  "scripts": {
    "build": "webpack --config webpack.config.js",
    "dev": "webpack serve --open"
  },
  "devDependencies": {
    "webpack": "^5.89.0",
    "webpack-cli": "^5.1.4",
    "html-webpack-plugin": "^5.5.4",
    "html-inline-script-webpack-plugin": "^3.2.0",
    "mini-css-extract-plugin": "^2.7.6",
    "html-inline-css-webpack-plugin": "^1.11.1",
    "css-loader": "^6.8.1"
  }
}
```

---

### æ­¥éª¤ 5ï¼šä¿®æ”¹ game.js çš„ TavernHelper è®¿é—®

**å…³é”®ä¿®æ”¹**ï¼ˆæ›¿æ¢ç¬¬ 461-500 è¡Œï¼‰ï¼š

```javascript
async sendToTavern(prompt, userInput) {
    console.log('[é…’é¦†æ£€æµ‹] å¼€å§‹æ£€æµ‹ TavernHelper API...');
    console.log('[é…’é¦†æ£€æµ‹] typeof window.TavernHelper:', typeof window.TavernHelper);

    // âœ… ç›´æ¥æ£€æŸ¥ window.TavernHelperï¼ˆé…’é¦†ä¼šå…¨å±€æ³¨å…¥ï¼‰
    if (typeof window.TavernHelper !== 'undefined' && window.TavernHelper.generate) {
        this.logMessage('system', 'âœ“ æ£€æµ‹åˆ° TavernHelper APIï¼Œå¼€å§‹é€šä¿¡');
        console.log('[é…’é¦†æ£€æµ‹] TavernHelper å¯ç”¨æ–¹æ³•:', Object.keys(window.TavernHelper));
        await this.sendViaTavernHelper(prompt, userInput);
        return;
    }

    // âŒ é™çº§åˆ°æ¨¡æ‹Ÿæ¨¡å¼ï¼ˆåªåœ¨å¼€å‘æµ‹è¯•æ—¶è§¦å‘ï¼‰
    console.warn('[é…’é¦†æ£€æµ‹] TavernHelper æœªæ‰¾åˆ°ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼');
    this.logMessage('system', 'âš  å½“å‰ä¸ºæ¼”ç¤ºæ¨¡å¼ï¼ˆTavernHelper ä¸å¯ç”¨ï¼‰');
    this.simulateAIResponse(userInput);
},

async sendViaTavernHelper(prompt, userInput) {
    try {
        this.logMessage('system', 'æ­£åœ¨å‘ AI å‘é€è¯·æ±‚...');

        // ä½¿ç”¨ TavernHelper.generate APIï¼ˆå‚è€ƒ GoblinGameï¼‰
        const generateConfig = {
            user_input: userInput, // ç”¨æˆ·è¾“å…¥
            should_stream: false   // æ˜¯å¦æµå¼è¾“å‡º
        };

        console.log('[TavernHelper] è°ƒç”¨ generate()...');
        const aiResponse = await window.TavernHelper.generate(generateConfig);
        console.log('[TavernHelper] AI å›å¤é•¿åº¦:', aiResponse?.length);

        // å¤„ç† AI å›å¤
        await this.processAIResponse(aiResponse);

    } catch (error) {
        console.error('[TavernHelper] é€šä¿¡å¤±è´¥:', error);
        this.logMessage('system', `é”™è¯¯: ${error.message}`);
        // é™çº§åˆ°æ¨¡æ‹Ÿæ¨¡å¼
        this.simulateAIResponse(userInput);
    }
},
```

**å…³é”®å˜åŒ–**ï¼š
1. âŒ åˆ é™¤ `parent.TavernHelper` çš„è®¿é—®å°è¯•
2. âœ… ç›´æ¥ä½¿ç”¨ `window.TavernHelper`
3. âœ… ä½¿ç”¨ GoblinGame çš„ API è°ƒç”¨æ–¹å¼

---

### æ­¥éª¤ 6ï¼šåˆ›å»ºè§’è‰²å¡åˆ†äº«æ¨¡æ¿

åˆ›å»º `è§’è‰²å¡-åæ´¾é€†è¢­ç³»ç»Ÿ.json`ï¼š

```json
{
  "name": "åæ´¾é€†è¢­ç³»ç»Ÿ",
  "description": "ä¸€ä¸ªä¿®ä»™ä¸–ç•Œçš„åæ´¾å…»æˆæ¸¸æˆ",
  "personality": "ä½ æ˜¯'åæ´¾é€†è¢­ç³»ç»ŸæŒ‡å—'æ¸¸æˆçš„ AI ä¸»æŒäºº...",
  "scenario": "ç©å®¶æ‰®æ¼”ä¸€ä¸ªè·å¾—åæ´¾ç³»ç»Ÿçš„ä¿®ä»™è€…...",
  "first_mes": "æ¬¢è¿æ¥åˆ°åæ´¾é€†è¢­ç³»ç»Ÿï¼\n\næ¸¸æˆç•Œé¢å·²åŠ è½½åœ¨å³ä¸Šè§’ã€‚\n\nè¯·å‘Šè¯‰æˆ‘ä½ æƒ³åšä»€ä¹ˆï¼Ÿ",
  "mes_example": "...",
  "creator_notes": "",
  "system_prompt": "# åæ´¾é€†è¢­ç³»ç»Ÿ - AI æŒ‡ä»¤\n\nå½“ç©å®¶è¡ŒåŠ¨å¯¼è‡´çŠ¶æ€å˜åŒ–æ—¶ï¼Œåœ¨å›å¤æœ«å°¾ä½¿ç”¨:\n{{state_update::å˜é‡å=æ–°å€¼}}\n\nå¯æ›´æ–°å˜é‡:\n- ç©å®¶.åæ´¾å€¼\n- ç©å®¶.å¢ƒç•Œ\n- å¥³æ€§è§’è‰².è§’è‰²å.å¥½æ„Ÿåº¦\n- å¥³æ€§è§’è‰².è§’è‰²å.èº«ä½“çŠ¶æ€\n- å¥³æ€§è§’è‰².è§’è‰²å.å¿ƒç†çŠ¶æ€",
  "post_history_instructions": "",
  "tags": ["game", "xianxia", "villain"],
  "creator": "YourName",
  "character_version": "1.0",
  "extensions": {
    "world": "",
    "depth_prompt": {
      "prompt": "",
      "depth": 4
    }
  },
  "character_book": {
    "entries": [
      {
        "keys": ["æ¸¸æˆç•Œé¢", "åæ´¾ç³»ç»Ÿ"],
        "content": "<iframe id=\"villain-game-frame\" src=\"https://ä½ çš„åŸŸå.pages.dev/index.html\" allow=\"clipboard-write\" style=\"position: fixed; top: 20px; right: 20px; width: 1200px; height: 800px; border: 2px solid #f0e68c; border-radius: 15px; z-index: 9999; box-shadow: 0 8px 32px rgba(0,0,0,0.7);\"></iframe>",
        "enabled": true,
        "insertion_order": 100,
        "case_sensitive": false,
        "priority": 100,
        "id": 0,
        "comment": "æ¸¸æˆç•Œé¢ iframe"
      }
    ]
  }
}
```

**ä½¿ç”¨æ–¹å¼**ï¼š
1. ç”¨æˆ·å¯¼å…¥è¿™ä¸ª JSON æ–‡ä»¶åˆ°é…’é¦†
2. æ¸¸æˆç•Œé¢è‡ªåŠ¨åŠ è½½ï¼ˆä» Cloudflare Pagesï¼‰
3. æ— éœ€ä»»ä½•æ‰‹åŠ¨å®‰è£…

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### å®Œæ•´æµç¨‹

```bash
# 1. å®‰è£…ä¾èµ–
cd villain-game-app
npm install

# 2. æœ¬åœ°æµ‹è¯•æ„å»º
npm run build
# æŸ¥çœ‹ dist/index.htmlï¼ˆåº”è¯¥æ˜¯å•æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰ä»£ç ï¼‰

# 3. æ¨é€åˆ° GitHub
git add .
git commit -m "é…ç½® Webpack å•æ–‡ä»¶æ‰“åŒ…"
git push origin main

# 4. GitHub Actions è‡ªåŠ¨è§¦å‘
# - è‡ªåŠ¨æ„å»º dist/index.html
# - è‡ªåŠ¨éƒ¨ç½²åˆ° Cloudflare Pages
# - è·å¾—è®¿é—® URL: https://villain-game.pages.dev

# 5. æ›´æ–°è§’è‰²å¡æ¨¡æ¿
# å°† iframe src æ”¹ä¸ºä½ çš„ Cloudflare Pages URL

# 6. åˆ†äº«è§’è‰²å¡
# ç”¨æˆ·å¯¼å…¥ JSON æ–‡ä»¶å³å¯å¼€å§‹æ¸¸æˆ
```

---

## ğŸ” è°ƒè¯•å’ŒéªŒè¯

### æœ¬åœ°æµ‹è¯•

```bash
# å¯åŠ¨æœ¬åœ°é…’é¦†ï¼ˆç¡®ä¿è¿è¡Œåœ¨ http://localhost:8000ï¼‰
cd SillyTavern
npm start

# åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ http://localhost:8000
# å¯¼å…¥è§’è‰²å¡æˆ–åœ¨ä¸–ç•Œä¹¦ä¸­æ·»åŠ  iframe
# æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š
# [é…’é¦†æ£€æµ‹] typeof window.TavernHelper: function
# [é…’é¦†æ£€æµ‹] TavernHelper å¯ç”¨æ–¹æ³•: ['generate', 'getChatMessages', ...]
```

### éªŒè¯ TavernHelper å¯ç”¨æ€§

åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼ˆiframe å†…ï¼‰è¿è¡Œï¼š

```javascript
// æµ‹è¯• 1ï¼šæ£€æŸ¥ TavernHelper æ˜¯å¦å­˜åœ¨
console.log('TavernHelper:', typeof window.TavernHelper);

// æµ‹è¯• 2ï¼šåˆ—å‡ºæ‰€æœ‰æ–¹æ³•
console.log('Methods:', Object.keys(window.TavernHelper));

// æµ‹è¯• 3ï¼šå°è¯•è°ƒç”¨ generate
window.TavernHelper.generate({
    user_input: 'ä½ å¥½'
}).then(res => console.log('AI å›å¤:', res));
```

**é¢„æœŸè¾“å‡º**ï¼š
```
TavernHelper: object
Methods: ['generate', 'getChatMessages', 'setChatMessages', 'createChatMessages', ...]
AI å›å¤: ä½ å¥½ï¼æˆ‘æ˜¯åæ´¾é€†è¢­ç³»ç»Ÿ...
```

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®‰è£…éš¾åº¦ | åˆ†äº«ä¾¿åˆ© | AI äº¤äº’ | è·¨åŸŸé—®é¢˜ |
|------|---------|---------|---------|---------|
| **æ—§æ–¹æ¡ˆï¼šæœ¬åœ°å®‰è£…** | âš ï¸ éœ€æ‰‹åŠ¨å¤åˆ¶æ–‡ä»¶ | âŒ éœ€åˆ†å‘æ–‡ä»¶å¤¹ | âœ… å®Œå…¨å¯ç”¨ | âœ… æ— è·¨åŸŸ |
| **æ–°æ–¹æ¡ˆï¼šè§’è‰²å¡åˆ†äº«** | âœ… æ— éœ€å®‰è£… | âœ… ä¸€é”®å¯¼å…¥ | âœ… å®Œå…¨å¯ç”¨ | âœ… æ— è·¨åŸŸï¼ˆwindow.TavernHelperï¼‰ |

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. TavernHelper çš„è®¿é—®æ–¹å¼

**é”™è¯¯ç†è§£** âŒï¼š
```javascript
// iframe éœ€è¦ä» parent è·å– TavernHelper
const helper = parent.TavernHelper; // è·¨åŸŸé”™è¯¯ï¼
```

**æ­£ç¡®ç†è§£** âœ…ï¼š
```javascript
// TavernHelper ä¼šè¢«é…’é¦†æ³¨å…¥åˆ° iframe çš„å…¨å±€ä½œç”¨åŸŸ
const helper = window.TavernHelper; // ç›´æ¥å¯ç”¨ï¼
```

### 2. iframe çš„ allow å±æ€§

```html
<iframe
    src="..."
    allow="clipboard-write"  <!-- å…è®¸å‰ªè´´æ¿è®¿é—® -->
    sandbox="allow-scripts allow-same-origin"  <!-- å…è®¸è„šæœ¬å’ŒåŒæº -->
>
```

### 3. Cloudflare Pages vs GitHub Pages

| ç‰¹æ€§ | Cloudflare Pages | GitHub Pages |
|-----|-----------------|--------------|
| **HTTPS** | âœ… è‡ªåŠ¨ | âœ… è‡ªåŠ¨ |
| **CDN** | âœ… å…¨çƒ 200+ èŠ‚ç‚¹ | âš ï¸ æœ‰é™ |
| **æ„å»ºé€Ÿåº¦** | âœ… å¿« | âš ï¸ æ…¢ |
| **è‡ªå®šä¹‰åŸŸå** | âœ… å…è´¹ | âœ… å…è´¹ |
| **æ¨è** | â­â­â­â­â­ | â­â­â­ |

---

## ğŸ‰ æœ€ç»ˆæ•ˆæœ

ç”¨æˆ·ä½“éªŒï¼š
1. ä¸‹è½½è§’è‰²å¡ JSON æ–‡ä»¶
2. åœ¨é…’é¦†ä¸­å¯¼å…¥è§’è‰²å¡
3. æ¸¸æˆç•Œé¢è‡ªåŠ¨å‡ºç°åœ¨å³ä¸Šè§’
4. ç›´æ¥å¼€å§‹ç©ï¼Œæ— éœ€ä»»ä½•å®‰è£…ï¼

å¼€å‘è€…ä½“éªŒï¼š
1. ä¿®æ”¹ä»£ç å¹¶æ¨é€åˆ° GitHub
2. GitHub Actions è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²
3. 5 åˆ†é’Ÿåå…¨çƒç”¨æˆ·éƒ½èƒ½è®¿é—®æ–°ç‰ˆæœ¬
4. æ— éœ€é€šçŸ¥ç”¨æˆ·æ›´æ–°ï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰

---

## ğŸ“š å‚è€ƒèµ„æº

- [GoblinGame æºç ](F:\AI\nova-creator-cli-master\GoblinGame)
- [TavernHelper API æ–‡æ¡£](https://github.com/SillyTavern/SillyTavern)
- [Cloudflare Pages æ–‡æ¡£](https://developers.cloudflare.com/pages/)
- [Webpack é…ç½®æŒ‡å—](https://webpack.js.org/configuration/)

---

ç”Ÿæˆæ—¶é—´: 2025-01-06
