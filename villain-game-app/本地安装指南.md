# 反派逆袭系统 - SillyTavern 本地安装指南

## 安装步骤

### 1. 准备文件

将以下文件复制到 SillyTavern 的 `public` 目录下:

```
SillyTavern/
└── public/
    └── villain-game/
        ├── index.html
        ├── game.js
        ├── style.css
        └── 反派逆袭系统指南.yaml
```

### 2. 在 SillyTavern 中嵌入游戏

#### 方法一：通过世界书嵌入（推荐）

在世界书条目中添加以下 HTML 代码:

```html
<iframe
    id="villain-game-frame"
    src="/villain-game/index.html"
    allow="clipboard-write"
    style="position: fixed; top: 20px; right: 20px; width: 1200px; height: 800px; border: 2px solid #f0e68c; border-radius: 15px; z-index: 9999; box-shadow: 0 8px 32px rgba(0,0,0,0.7);">
</iframe>
```

#### 方法二：通过角色卡嵌入

在角色卡的描述字段中添加相同的 iframe 代码。

### 3. 配置 AI 提示词

在角色卡的**系统提示词**或**作者注释**中添加:

```
你是"反派逆袭系统指南"游戏的AI主持人。

# 游戏状态更新规则
当玩家的行动导致游戏状态变化时,请在你的回复末尾使用以下格式:

{{state_update::变量名=新值}}

# 可更新的变量
- 玩家.反派值 - 数字,当玩家完成反派行为时增加
- 玩家.境界 - 字符串,如"筑基十一层"
- 世界.当前地点 - 字符串,当前所在位置
- 世界.时间 - 字符串,游戏内时间
- 玩家.当前拥有的物品 - 数组,物品列表
- 女性角色.角色名.好感度 - 数字(-100到100)
- 女性角色.角色名.身体状态 - 字符串,50字左右的描写
- 女性角色.角色名.心理状态 - 字符串,50字左右的内心想法

# 示例回应
"你成功拦截了龙战的机缘,夺得了《龙象镇狱功》古卷。周围的修士都对你的手段感到敬畏。

{{state_update::玩家.反派值=2500}}
{{state_update::世界.当前地点=藏经阁}}
{{state_update::玩家.当前拥有的物品=['龙象镇狱功古卷']}}
{{state_update::女性角色.秦岚.好感度=95}}
{{state_update::女性角色.秦岚.心理状态=看着父亲得到如此强大的功法,心中既为父亲高兴,又担心这会引来不必要的麻烦}}"
```

### 4. 配置正则替换（可选）

在 SillyTavern 的**扩展** > **正则替换**中添加:

**名称**: `清理游戏状态标记`

**查找正则**:
```regex
\{\{state_update::[^}]+\}\}
```

**替换为**: （留空）

**选项**:
- ☑ 启用
- ☑ 仅输出
- ☐ 仅输入

### 5. 验证安装

1. 重启或刷新 SillyTavern
2. 打开浏览器控制台(F12)
3. 查看游戏界面是否正常显示
4. 检查控制台输出:
   - 应该看到 `✓ 检测到TavernHelper API，使用直接通信`
   - 不应该看到跨域错误

### 6. 测试功能

1. 在游戏中输入消息
2. 观察 AI 是否收到消息并回复
3. 检查游戏状态是否正确更新

## 故障排除

### 问题: 游戏界面不显示

**解决方案**:
1. 检查文件路径是否正确
2. 确认 `public/villain-game/` 目录存在
3. 尝试直接访问 `http://localhost:8000/villain-game/index.html`

### 问题: TavernHelper 仍然 undefined

**解决方案**:
1. 确认 TavernHelper 扩展已安装并启用
2. 检查 SillyTavern 版本 (需要 1.11.0+)
3. 尝试清除浏览器缓存并重启

### 问题: AI 收到消息但状态不更新

**解决方案**:
1. 检查 AI 回复中是否包含 `{{state_update::}}` 标记
2. 查看浏览器控制台是否有解析错误
3. 确认变量路径格式正确

## 本地安装的优势

✅ **无跨域限制**: 直接访问 TavernHelper API
✅ **更快的加载速度**: 无需从网络加载资源
✅ **完全离线**: 不依赖 GitHub Pages
✅ **更好的稳定性**: 不受网络波动影响

## 技术说明

本地安装方式与归墟Plus的实现方式相同,将游戏作为 SillyTavern 的本地资源加载,从而避免了跨域安全限制。游戏运行在与 SillyTavern 相同的源(origin)下,可以直接访问 `TavernHelper` API。

---

**安装版本**: 本地版 v1.0
**更新日期**: 2025-01-06
