# 同层游玩 (Co-layer Play) 实现方案

## 概述

“同层游玩”是指在现有应用程序界面（如酒馆插件环境）中无缝集成和运行一个独立的外部Web应用程序，使其在用户体验上感觉如同原生界面的一部分，而非跳转到新的窗口或标签页。这极大地扩展了宿主环境的功能，允许实现从简单工具到复杂单页面应用（SPA）的任意功能。

## 实现方案对比

| 方案 | 核心思想 | 优点 | 缺点 | 适用场景 |
| :--- | :--- | :--- | :--- | :--- |
| **1. HTML内容注入** | 在宿主页面通过AJAX加载并注入外部HTML片段。 | 简单、快速、轻量。 | 功能和结构受限，耦合度较高。 | 快速实现简单的、独立的UI组件（如计算器、信息展示面板）。 |
| **2. 自包含SPA** | 将宿主页面本身作为承载一个完整单页面应用的容器。 | 功能强大、结构清晰、模块化、可维护性高。 | 配置复杂，需要前端工程化知识。 | 开发复杂的、有状态的、多视图的应用程序。 |

---

## 方案一：HTML内容注入（简单方法）

此方案利用`jQuery.load()`等方法，将一个远程HTML文件的内容动态加载到当前页面的指定元素内。

---

## 方案二：自包含单页面应用 (SPA)（高级方法）

此方案将卡片内容本身编写为一个完整的HTML文件，它负责加载一个基于现代前端框架（如Vue.js, React）构建的单页面应用。这是更专业、更强大的做法。

### SPA方案中的AI行为逻辑

在传统的关键词-世界书模型中，AI的行为是响应式的、自由度高的。而在SPA方案中，前端应用自身扮演了“游戏引擎”或“地下城主(DM)”的角色，AI的行为由程序逻辑精确控制。这使得互动体验更接近一个真正的电子游戏。

其工作流如下：

#### 1. 状态管理 (State Management)
应用在内存中维护着完整的游戏状态，而不是依赖外部文件。所有数据都以JavaScript变量或对象的形式存在。

```javascript
// main.js
const gameState = {
  player: { level: 5, location: '新手村' },
  quests: { findHerb: 'accepted' },
  npcRelations: { villageChief: 50 }
};
```

#### 2. 事件处理 (Event Handling)
用户的任何交互（如点击按钮）都会触发应用内的特定JavaScript函数。

```html
<button onclick="talkToChief()">与村长对话</button>
```

#### 3. 条件逻辑 (Conditional Logic)
被触发的函数会检查当前的`gameState`，并根据预设的条件执行不同的逻辑分支。

```javascript
// main.js
function talkToChief() {
  if (gameState.quests.findHerb === 'accepted') {
    // 如果任务已接受，生成催促任务的提示
    return generatePrompt('urge_quest');
  } else if (gameState.player.level > 10) {
    // 如果玩家等级高，生成高级任务的提示
    return generatePrompt('offer_advanced_quest');
  } else {
    // 默认生成日常问候
    return generatePrompt('daily_greeting');
  }
}
```

#### 4. 动态提示词构建 (Dynamic Prompt Construction)
根据逻辑判断的结果，程序会动态地、程序化地构建一个带有精确指令的提示词(Prompt)。

```javascript
// main.js
function generatePrompt(type) {
  const base = `你将扮演村长。玩家'${gameState.player.name}'正在你面前。`;
  let instruction = '';

  if (type === 'urge_quest') {
    instruction = '你的任务是：催促玩家尽快完成寻找草药的任务。';
  } else if (type === 'offer_advanced_quest') {
    instruction = `你的任务是：表达对这位高级别(${gameState.player.level}级)勇者的敬意，并提供更严峻的挑战。`;
  }
  
  const finalPrompt = `${base} ${instruction} 请生成一句符合场景的对话。`;
  // -> '你将扮演村长。玩家'北斗'正在你面前。你的任务是：催促玩家...'
  return finalPrompt;
}
```

#### 5. AI调用 (AI Call)
最后，应用将这个构建好的`finalPrompt`发送给AI模型，并将返回的文本渲染到界面上。这确保了AI的每一次输出都精确地服务于当前的游戏逻辑。
