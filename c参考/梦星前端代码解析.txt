# å½’å¢ŸPlusé¡¹ç›®MVUç³»ç»Ÿè®°å¿†é“¶è¡Œ

## ç¬¬ä¸€ç« ï¼šå‰ç«¯UIé€»è¾‘ä¸åˆå§‹åŒ–æœºåˆ¶

### 1.1 GuixuManageræ ¸å¿ƒæ¶æ„
å½’å¢ŸPlusçš„å‰ç«¯ä½¿ç”¨å•ä¾‹æ¨¡å¼çš„`GuixuManager`å¯¹è±¡ç®¡ç†æ•´ä¸ªUIç³»ç»Ÿï¼Œè¯¥å¯¹è±¡åŒ…å«ä»¥ä¸‹æ ¸å¿ƒå±æ€§ï¼š

- `currentMvuState`: ç¼“å­˜æœ€æ–°çš„MVUå®Œæ•´çŠ¶æ€
- `baseAttributes`: å­˜å‚¨ä»MVUåŠ è½½çš„åŸå§‹å››ç»´å±æ€§
- `equippedItems`: è¿½è¸ªå·²è£…å¤‡ç‰©å“çŠ¶æ€
- `pendingActions`: å¾…æ‰§è¡Œçš„æŒ‡ä»¤é˜Ÿåˆ—

### 1.2 åˆå§‹åŒ–æµç¨‹
```javascript
async init() {
  console.log('å½’å¢ŸUIäº¤äº’ç®¡ç†å™¨åˆå§‹åŒ–...');
  this.bindStaticListeners();        // ç»‘å®šé™æ€äº‹ä»¶ç›‘å¬å™¨
  this.applyRandomBackground();      // åº”ç”¨éšæœºèƒŒæ™¯
  await this.updateDynamicData();    // åŠ è½½MVUæ•°æ®
  this.loadAutoWriteState();         // åŠ è½½è‡ªåŠ¨å†™å…¥çŠ¶æ€
  this.loadNovelModeState();         // åŠ è½½å°è¯´æ¨¡å¼çŠ¶æ€
  this.loadEquipmentState();         // åŠ è½½è£…å¤‡çŠ¶æ€
  this.loadPendingActions();         // åŠ è½½å¾…å¤„ç†æŒ‡ä»¤
  this.loadViewMode();               // åŠ è½½è§†å›¾æ¨¡å¼
}
```

### 1.3 äº‹ä»¶ç›‘å¬å™¨é˜²é‡å¤ç»‘å®šæœºåˆ¶
```javascript
bindStaticListeners() {
  if (this.listenersBound) return; // é˜²æ­¢é‡å¤ç»‘å®š
  
  // ç»‘å®šå„ç§UIäº‹ä»¶ç›‘å¬å™¨...
  
  this.listenersBound = true; // è®¾ç½®æ ‡å¿—ä½
}
```

## ç¬¬äºŒç« ï¼šæ ¸å¿ƒæ•°æ®æµä¸GuixuManageræ¶æ„

### 2.1 æ•°æ®è·å–ä¸ç¼“å­˜ç­–ç•¥

#### 2.1.1 ä»SillyTavernè·å–MVUæ•°æ®
```javascript
async updateDynamicData() {
  try {
    const messages = await getChatMessages(getCurrentMessageId());
    if (messages && messages.length > 0 && messages[0].data) {
      this.currentMvuState = messages[0].data; // ç¼“å­˜å®Œæ•´MVUçŠ¶æ€
      this.renderUI(this.currentMvuState.stat_data);
    }
    await this.loadAndDisplayCurrentScene(); // åŠ è½½åœºæ™¯æ­£æ–‡
  } catch (error) {
    console.error('æ›´æ–°å½’å¢ŸåŠ¨æ€æ•°æ®æ—¶å‡ºé”™:', error);
  }
}
```

#### 2.1.2 SafeGetValueç»Ÿä¸€æ•°æ®è®¿é—®æ¨¡å¼
```javascript
SafeGetValue(obj, path, defaultValue = 'N/A') {
  let keys = Array.isArray(path) ? path : path.split('.');
  let current = obj;
  
  for (let i = 0; i < keys.length; i++) {
    if (current === undefined || current === null || !current.hasOwnProperty(keys[i])) {
      return defaultValue;
    }
    current = current[keys[i]];
  }
  
  // å¤„ç†MVUçš„æ•°ç»„æ ¼å¼æ•°æ® [å€¼, "æè¿°"]
  if (Array.isArray(current) && current.length > 0) {
    return String(current[0]); // è¿”å›å®é™…å€¼
  }
  
  return String(current);
}
```

### 2.2 UIæ¸²æŸ“æ ¸å¿ƒæµç¨‹

#### 2.2.1 renderUIç»Ÿä¸€æ¸²æŸ“å‡½æ•°
```javascript
renderUI(data) {
  if (!data) return;
  
  // 1. æ›´æ–°åŸºç¡€çŠ¶æ€æ˜¾ç¤º
  const updateText = (id, value, style = '') => {
    const el = document.getElementById(id);
    if (el) {
      el.innerText = value;
      if (style) el.setAttribute('style', style);
    }
  };
  
  // 2. æ¸²æŸ“å¢ƒç•Œå’Œæ—¶é—´
  const jingjieValue = this.SafeGetValue(data, 'å½“å‰å¢ƒç•Œ');
  const tierStyle = this.getTierStyle(jingjieValue.match(/^(\S{2})/)?.[1] || '');
  updateText('val-jingjie', jingjieValue, tierStyle);
  updateText('val-jinian', this.SafeGetValue(data, 'å½“å‰æ—¶é—´çºªå¹´'));
  
  // 3. æ›´æ–°å½’å¢Ÿå……èƒ½è¿›åº¦æ¡
  const charge = this.SafeGetValue(data, 'å½’å¢Ÿå……èƒ½æ—¶é—´', '0');
  updateText('val-guixu-charge-text', `${charge}%`);
  const chargeBar = document.getElementById('bar-guixu-charge');
  if (chargeBar) chargeBar.style.setProperty('--guixu-charge', `${charge}%`);
  
  // 4. å¤„ç†å››ç»´å±æ€§
  this.baseAttributes = {
    fali: parseInt(this.SafeGetValue(data, 'æ³•åŠ›', 0), 10),
    currentFali: parseInt(this.SafeGetValue(data, 'å½“å‰æ³•åŠ›', 0), 10),
    shenhai: parseInt(this.SafeGetValue(data, 'ç¥æµ·', 0), 10),
    currentShenhai: parseInt(this.SafeGetValue(data, 'å½“å‰ç¥æµ·', 0), 10),
    // ... å…¶ä»–å±æ€§
  };
  
  // 5. æ›´æ–°å¤æ‚UIç»„ä»¶
  this.updateTalentAndLinggen(data);
  this.loadEquipmentFromMVU(data);
  this.updateDisplayedAttributes();
}
```

## ç¬¬ä¸‰ç« ï¼šç”¨æˆ·äº¤äº’å¤„ç†ä¸äº‹ä»¶ç³»ç»Ÿ

### 3.1 äº‹ä»¶å§”æ‰˜æ¨¡å¼

#### 3.1.1 èƒŒåŒ…äº¤äº’äº‹ä»¶å¤„ç†
```javascript
// ä½¿ç”¨äº‹ä»¶å§”æ‰˜å‡å°‘å†…å­˜å ç”¨
const inventoryModalBody = document.querySelector('#inventory-modal .modal-body');
inventoryModalBody.addEventListener('click', e => {
  if (e.target.classList.contains('item-equip-btn')) {
    const itemElement = e.target.closest('.inventory-item');
    const itemData = JSON.parse(itemElement.dataset.itemDetails);
    const category = itemElement.dataset.category;
    this.equipItem(itemData, category, e.target);
  } else if (e.target.classList.contains('item-use-btn')) {
    const itemElement = e.target.closest('.inventory-item');
    const itemData = JSON.parse(itemElement.dataset.itemDetails);
    this.useItem(itemData, e.target);
  }
});
```

### 3.2 è£…å¤‡ç³»ç»Ÿäº¤äº’é€»è¾‘

#### 3.2.1 è£…å¤‡æ“ä½œçš„ä¹è§‚æ›´æ–°æ¨¡å¼
```javascript
equipItem(item, category, buttonElement, equipType = null) {
  // 1. å‰ç«¯ä¹è§‚æ›´æ–°
  this.equippedItems[slotKey] = item;
  slotElement.textContent = this.SafeGetValue(item, 'name');
  slotElement.classList.add('equipped');
  
  // 2. ç«‹å³æ›´æ–°å±æ€§æ˜¾ç¤º
  this.updateDisplayedAttributes();
  
  // 3. æ·»åŠ åˆ°æŒ‡ä»¤é˜Ÿåˆ—
  this.pendingActions.push({
    action: 'equip',
    itemName: itemName,
    category: slotFriendlyName
  });
  
  // 4. ä¿å­˜çŠ¶æ€åˆ°localStorage
  this.saveEquipmentState();
  this.savePendingActions();
  
  this.showTemporaryMessage(`å·²è£…å¤‡ ${this.SafeGetValue(item, 'name')}`);
}
```

### 3.3 æ¨¡æ€æ¡†ç®¡ç†ç³»ç»Ÿ

#### 3.3.1 ç»Ÿä¸€æ¨¡æ€æ¡†æ§åˆ¶
```javascript
openModal(modalId) {
  this.closeAllModals(); // ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªæ¨¡æ€æ¡†
  const modal = document.getElementById(modalId);
  if (modal) modal.style.display = 'flex';
}

closeAllModals() {
  document.querySelectorAll('.modal-overlay').forEach(modal => {
    modal.style.display = 'none';
  });
}
```

#### 3.3.2 å¼‚æ­¥æ•°æ®åŠ è½½æ¨¡å¼
```javascript
async showInventory() {
  this.openModal('inventory-modal');
  const body = document.querySelector('#inventory-modal .modal-body');
  body.innerHTML = 'æ­£åœ¨æ¸…ç‚¹è¡Œå›Š...'; // åŠ è½½æç¤º
  
  try {
    const messages = await getChatMessages(getCurrentMessageId());
    const stat_data = messages[0].data.stat_data;
    body.innerHTML = this.renderInventory(stat_data);
  } catch (error) {
    body.innerHTML = `åŠ è½½èƒŒåŒ…æ—¶å‡ºé”™: ${error.message}`;
  }
}
```

## ç¬¬å››ç« ï¼šæ•°æ®æŒä¹…åŒ–ä¸ç¼“å­˜ç­–ç•¥

### 4.1 å¤šå±‚æŒä¹…åŒ–æ¶æ„

#### 4.1.1 localStorageåˆ†å±‚ç¼“å­˜
```javascript
// è£…å¤‡çŠ¶æ€æŒä¹…åŒ–
saveEquipmentState() {
  try {
    localStorage.setItem('guixu_equipped_items', JSON.stringify(this.equippedItems));
  } catch (e) {
    console.error('ä¿å­˜è£…å¤‡çŠ¶æ€å¤±è´¥:', e);
  }
}

// æŒ‡ä»¤é˜Ÿåˆ—æŒä¹…åŒ–
savePendingActions() {
  try {
    localStorage.setItem('guixu_pending_actions', JSON.stringify(this.pendingActions));
  } catch (e) {
    console.error('ä¿å­˜æŒ‡ä»¤é˜Ÿåˆ—å¤±è´¥:', e);
  }
}
```

#### 4.1.2 åŒå±‚æ¸¸ç©æœºåˆ¶
```javascript
// æ— åˆ·æ–°çŠ¶æ€åŒæ­¥åˆ°ç¬¬0å±‚æ¶ˆæ¯
const messages = await getChatMessages('0');
const messageZero = messages[0];
messageZero.message = aiResponse;        // AIå›å¤æ–‡æœ¬
messageZero.data = this.currentMvuState; // MVUçŠ¶æ€æ•°æ®
await TavernHelper.setChatMessages([messageZero], { refresh: 'none' });
```

### 4.2 å¤šå­˜æ¡£ç®¡ç†ç³»ç»Ÿ

#### 4.2.1 å­˜æ¡£æ•°æ®ç»“æ„
```javascript
// å­˜æ¡£æ•°æ®æ ¼å¼
const saveDataPayload = {
  timestamp: new Date().toISOString(),
  message_content: currentMessageContent,
  mvu_data: {
    stat_data: currentMvuData.stat_data,
    schema: currentMvuData.schema,
    initialized_lorebooks: currentMvuData.initialized_lorebooks
  }
};
```

#### 4.2.2 å­˜æ¡£æ§½ä½ç®¡ç†
```javascript
async saveGame(slotId) {
  const allSaves = this.getSavesFromStorage();
  allSaves[slotId] = saveDataPayload;
  localStorage.setItem('guixu_multi_save_data', JSON.stringify(allSaves));
  this.showTemporaryMessage(`æ¸¸æˆå·²ä¿å­˜åˆ°å­˜æ¡£ä½ ${slotId.split('_')[1]}`);
}
```

## ç¬¬äº”ç« ï¼šå†…å®¹æå–ä¸ä¸–ç•Œä¹¦é›†æˆ

### 5.1 AIå›å¤å†…å®¹è§£æ

#### 5.1.1 æ ‡ç­¾å†…å®¹æå–æœºåˆ¶
```javascript
_extractLastTagContent(tagName, text, ignoreCase = false) {
  if (!text || typeof text !== 'string') return null;
  
  const endTag = `</${tagName}>`;
  let searchPool = text;
  let endTagPattern = endTag;
  
  if (ignoreCase) {
    searchPool = text.toLowerCase();
    endTagPattern = endTag.toLowerCase();
  }
  
  const lastEndIndex = searchPool.lastIndexOf(endTagPattern);
  if (lastEndIndex !== -1) {
    const startTag = `<${tagName}>`;
    const lastStartIndex = searchPool.lastIndexOf(startTag, lastEndIndex);
    if (lastStartIndex !== -1) {
      return text.substring(lastStartIndex + startTag.length, lastEndIndex).trim();
    }
  }
  return null;
}
```

#### 5.1.2 å¤šç±»å‹å†…å®¹åŒæ­¥æå–
```javascript
async loadAndDisplayCurrentScene(messageContent = null) {
  // 1. è·å–AIå›å¤å†…å®¹
  if (!messageContent) {
    const messages = await getChatMessages(getCurrentMessageId());
    const lastAiMessage = [...messages].reverse().find(m => m.role === 'assistant');
    messageContent = lastAiMessage?.message;
  }
  
  // 2. æå–å„ç±»æ ‡ç­¾å†…å®¹
  this.lastExtractedNovelText = this._extractLastTagContent('gametxt', messageContent);
  this.lastExtractedJourney = this._extractLastTagContent('æœ¬ä¸–å†ç¨‹', messageContent);
  this.lastExtractedPastLives = this._extractLastTagContent('å¾€ä¸–æ¶Ÿæ¼ª', messageContent);
  this.lastExtractedVariables = this._extractLastTagContent('UpdateVariable', messageContent, true);
  this.lastExtractedCharacterCard = this._extractLastTagContent('è§’è‰²æå–', messageContent);
  
  // 3. æ›´æ–°ä¸»ç•Œé¢æ˜¾ç¤º
  const displayText = this._getDisplayText(messageContent);
  gameTextDisplay.innerHTML = this.formatMessageContent(displayText);
}
```

### 5.2 ä¸–ç•Œä¹¦è‡ªåŠ¨å†™å…¥ç³»ç»Ÿ

#### 5.2.1 åŠ¨æ€æ¡ç›®åˆ›å»ºæœºåˆ¶
```javascript
async writeToLorebook(baseEntryKey, contentToWrite, silent = false) {
  const index = this.lorebookWriteIndex;
  const finalEntryKey = index > 1 ? `${baseEntryKey}(${index})` : baseEntryKey;
  const bookName = '1å½’å¢Ÿ';
  
  // æ£€æŸ¥æ¡ç›®æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
  const allEntries = await TavernHelper.getLorebookEntries(bookName);
  let targetEntry = allEntries.find(entry => entry.comment === finalEntryKey);
  
  if (!targetEntry) {
    const baseEntryTemplate = allEntries.find(entry => entry.comment === baseEntryKey);
    const newEntryData = {
      comment: finalEntryKey,
      content: contentToWrite,
      keys: baseEntryTemplate ? [...baseEntryTemplate.keys, finalEntryKey] : [finalEntryKey],
      enabled: false
    };
    
    await TavernHelper.createLorebookEntries(bookName, [newEntryData]);
  } else {
    // è¿½åŠ å†…å®¹åˆ°ç°æœ‰æ¡ç›®
    const updatedContent = targetEntry.content + '\n\n' + contentToWrite;
    await TavernHelper.setLorebookEntries(bookName, [{ uid: targetEntry.uid, content: updatedContent }]);
  }
}
```

#### 5.2.2 è½®è¯¢è‡ªåŠ¨å†™å…¥æœºåˆ¶
```javascript
startAutoWritePolling() {
  this.autoWriteIntervalId = setInterval(() => {
    if (this.lastExtractedJourney) {
      this.writeJourneyToLorebook(true); // é™é»˜å†™å…¥
    }
    if (this.lastExtractedPastLives) {
      this.writePastLivesToLorebook(true);
    }
  }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
}
```

## ç¬¬å…­ç« ï¼šMVUå˜é‡ç»“æ„å®šä¹‰ä¸æ‰©å±•æ€§

### 6.1 åŸºç¡€å˜é‡ç»“æ„æ˜ å°„

#### 6.1.1 å››ç»´å±æ€§ç³»ç»Ÿ
æ ¹æ®`mvuå˜é‡ä¹‹å‰.txt`ï¼ŒMVUå˜é‡é‡‡ç”¨`[å€¼, "æè¿°"]`çš„æ•°ç»„æ ¼å¼ï¼š

```javascript
// MVUå˜é‡ç»“æ„ç¤ºä¾‹
"æ³•åŠ›": [100, "ã€å››ç»´èƒ½åŠ›åŸºçŸ³ã€‘å†³å®šè§’è‰²çš„æ³•åŠ›ä¸Šé™"],
"å½“å‰æ³•åŠ›": [100, "ã€çŠ¶æ€å®æ—¶èµ„æºã€‘è§’è‰²å½“å‰å¯ç”¨çš„æ³•åŠ›å€¼"],
"ç¥æµ·": [50, "ã€å››ç»´èƒ½åŠ›åŸºçŸ³ã€‘å†³å®šè§’è‰²çš„ç¥æµ·åšéŸ§åº¦ä¸æ„ŸçŸ¥ä¸Šé™"],
"å½“å‰ç¥æµ·": [50, "ã€çŠ¶æ€å®æ—¶èµ„æºã€‘è§’è‰²å½“å‰çš„ç¥æµ·å¼ºåº¦"]
```

#### 6.1.2 å¤æ‚å¯¹è±¡ç»“æ„
```javascript
// çµæ ¹å¯¹è±¡ç»“æ„
"çµæ ¹": [{
  "åç§°": "æ‚çµæ ¹",
  "å“é˜¶": "å‡¡å“", 
  "æè¿°": "æœ€æ™®é€šçš„çµæ ¹ï¼Œä¿®ç‚¼é€Ÿåº¦ç¼“æ…¢"
}, "ã€çµæ ¹ä¿®ç‚¼æ ¹åŸºã€‘å†³å®šå¸æ”¶çµæ°”çš„æ•ˆç‡å’Œå±æ€§"]

// è£…å¤‡å¯¹è±¡ç»“æ„
"æ­¦å™¨": [null, "ã€è£…å¤‡æ èƒ½åŠ›ä¸­æ¢ã€‘å½“å‰è£…å¤‡çš„æ­¦å™¨"]
// æˆ–è£…å¤‡æ—¶ï¼š
"æ­¦å™¨": [{
  id: 'å”¯ä¸€ID',
  name: 'åç§°',
  tier: 'å“é˜¶',
  attributes_bonus: {'æ³•åŠ›': 10},
  special_effects: ['è¯æ¡æè¿°']
}, "ã€è£…å¤‡æ èƒ½åŠ›ä¸­æ¢ã€‘å½“å‰è£…å¤‡çš„æ­¦å™¨"]
```

### 6.2 æ‰©å±•æ€§æ§åˆ¶æœºåˆ¶

#### 6.2.1 META_EXTENSIBLEç³»ç»Ÿ
```javascript
// å¯æ‰©å±•åˆ—è¡¨ç»“æ„
"å¤©èµ‹åˆ—è¡¨": [
  ["$__META_EXTENSIBLE__$"], 
  "ã€å¤©èµ‹ç‰¹æ®Šèµ›é“ã€‘è®°å½•è§’è‰²çš„å¤©èµ‹èƒ½åŠ›"
]

// æ·»åŠ å…ƒç´ æ—¶
"å¤©èµ‹åˆ—è¡¨": [
  [å¤©èµ‹å¯¹è±¡1, å¤©èµ‹å¯¹è±¡2, "$__META_EXTENSIBLE__$"],
  "ã€å¤©èµ‹ç‰¹æ®Šèµ›é“ã€‘è®°å½•è§’è‰²çš„å¤©èµ‹èƒ½åŠ›"  
]
```

#### 6.2.2 Schemaé©±åŠ¨çš„éªŒè¯
```javascript
// é¡¶å±‚Schemaæ§åˆ¶
{
  "$meta": {
    "extensible": true  // å…è®¸åŠ¨æ€æ·»åŠ æ–°å˜é‡
  },
  // ... å˜é‡å®šä¹‰
}
```

### 6.3 å˜é‡è®¿é—®æ¨¡å¼

#### 6.3.1 ç»Ÿä¸€è®¿é—®æ¥å£
```javascript
// å‰ç«¯ç»Ÿä¸€ä½¿ç”¨SafeGetValueè®¿é—®
const jingjie = this.SafeGetValue(data, 'å½“å‰å¢ƒç•Œ');  // è·å–æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ 
const linggenName = this.SafeGetValue(data, 'çµæ ¹.åç§°'); // è·å–å¯¹è±¡å±æ€§
```

#### 6.3.2 ç±»å‹é€‚é…å¤„ç†
```javascript
// å¤„ç†å¯èƒ½çš„æ•°æ®ç±»å‹å˜åŒ–
let relationships = stat_data['äººç‰©å…³ç³»åˆ—è¡¨']?.[0];
if (typeof relationships === 'string') {
  try {
    relationships = JSON.parse(relationships);
  } catch (e) {
    relationships = [];
  }
}
```

## ç¬¬ä¸ƒç« ï¼šæ‰©å±•æ€§å®‰å…¨æœºåˆ¶ä¸Schemaæ§åˆ¶

### 7.1 æ•°æ®å®Œæ•´æ€§ä¿æŠ¤

#### 7.1.1 SchemaéªŒè¯æœºåˆ¶
MVUç³»ç»Ÿé€šè¿‡å¤šå±‚éªŒè¯ç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼š

```javascript
// 1. ç»“æ„éªŒè¯
if (!messages || !messages[0].data || !messages[0].data.stat_data) {
  console.warn('MVUæ•°æ®ç»“æ„ä¸å®Œæ•´');
  return;
}

// 2. ç±»å‹éªŒè¯  
const value = this.SafeGetValue(data, path);
if (typeof value !== 'string' && typeof value !== 'number') {
  console.warn(`å˜é‡${path}ç±»å‹å¼‚å¸¸:`, typeof value);
}
```

#### 7.1.2 é˜²å¾¡æ€§ç¼–ç¨‹æ¨¡å¼
```javascript
// å®‰å…¨çš„å±æ€§è®¿é—®
const tianfuList = _.get(data, 'å¤©èµ‹åˆ—è¡¨.0', []);
if (Array.isArray(tianfuList) && tianfuList[0] !== '$__META_EXTENSIBLE__$') {
  tianfuList.forEach(rawTianfu => {
    try {
      const tianfu = typeof rawTianfu === 'string' ? JSON.parse(rawTianfu) : rawTianfu;
      // å¤„ç†å¤©èµ‹å¯¹è±¡...
    } catch (e) {
      console.error('è§£æå¤©èµ‹å¤±è´¥:', e);
    }
  });
}
```

### 7.2 æ‰©å±•æ€§è¾¹ç•Œæ§åˆ¶

#### 7.2.1 å—æ§æ‰©å±•æœºåˆ¶
```javascript
// åªæœ‰æ ‡è®°ä¸ºå¯æ‰©å±•çš„åˆ—è¡¨æ‰èƒ½æ·»åŠ å…ƒç´ 
const isExtensible = Array.isArray(listData) && 
                    listData.includes('$__META_EXTENSIBLE__$');

if (isExtensible) {
  // å®‰å…¨æ·»åŠ æ–°å…ƒç´ 
  const cleanList = listData.filter(item => item !== '$__META_EXTENSIBLE__$');
  cleanList.push(newItem);
  cleanList.push('$__META_EXTENSIBLE__$');
}
```

#### 7.2.2 Schemaä¸€è‡´æ€§æ£€æŸ¥
```javascript
// å®šæœŸéªŒè¯æ•°æ®Schemaä¸€è‡´æ€§
validateSchema(data) {
  const requiredFields = ['å½“å‰å¢ƒç•Œ', 'æ³•åŠ›', 'ç¥æµ·', 'é“å¿ƒ', 'ç©ºé€Ÿ'];
  const missingFields = requiredFields.filter(field => 
    !data.hasOwnProperty(field) || this.SafeGetValue(data, field) === 'N/A'
  );
  
  if (missingFields.length > 0) {
    console.error('SchemaéªŒè¯å¤±è´¥ï¼Œç¼ºå°‘å­—æ®µ:', missingFields);
    return false;
  }
  return true;
}
```

### 7.3 é”™è¯¯æ¢å¤æœºåˆ¶

#### 7.3.1 æ•°æ®å›é€€ç­–ç•¥
```javascript
// å½“æ£€æµ‹åˆ°æ•°æ®æŸåæ—¶çš„æ¢å¤æœºåˆ¶
async recoverFromCorruption() {
  try {
    // 1. å°è¯•ä»localStorageæ¢å¤
    const backupState = localStorage.getItem('guixu_last_good_state');
    if (backupState) {
      const restoredState = JSON.parse(backupState);
      this.currentMvuState = restoredState;
      this.renderUI(restoredState.stat_data);
      return true;
    }
    
    // 2. ä»å†å²æ¶ˆæ¯ä¸­æ¢å¤
    const messages = await getChatMessages(getCurrentMessageId() - 1);
    if (messages?.[0]?.data) {
      this.currentMvuState = messages[0].data;
      this.renderUI(messages[0].data.stat_data);
      return true;
    }
  } catch (error) {
    console.error('æ•°æ®æ¢å¤å¤±è´¥:', error);
  }
  return false;
}
```

## ç¬¬å…«ç« ï¼šæ ¸å¿ƒè„šæœ¬çš„å‘½ä»¤è§£æä¸æ‰§è¡Œæµç¨‹

### 8.1 å‘½ä»¤æå–ä¸è§£ææœºåˆ¶

#### 8.1.1 æ­£åˆ™è¡¨è¾¾å¼å‘½ä»¤è¯†åˆ«
```javascript
_extractCommands(inputText) {
  const results = [];
  let i = 0;
  
  // æŸ¥æ‰¾ _.set(), _.assign(), _.remove(), _.add(), _.insert() å‘½ä»¤
  while (i < inputText.length) {
    const match = inputText.substring(i).match(/_\.(set|assign|remove|add|insert)\(/);
    if (!match || match.index === undefined) break;
    
    const commandType = match[1];
    const start = i + match.index;
    const openParen = start + match[0].length;
    const closeParen = this._findMatchingCloseParen(inputText, openParen);
    
    if (closeParen === -1) {
      i = openParen;
      continue;
    }
    
    // è§£æå‚æ•°
    const paramsString = inputText.substring(openParen, closeParen);
    const params = this._parseParameters(paramsString);
    
    results.push({ command: commandType, args: params });
    i = closeParen + 1;
  }
  
  return results;
}
```

#### 8.1.2 å‚æ•°è§£æå¤„ç†
```javascript
_parseCommandValue(valStr) {
  if (typeof valStr !== 'string') return valStr;
  const trimmed = valStr.trim();
  
  // å¸ƒå°”å€¼å¤„ç†
  if (trimmed === 'true') return true;
  if (trimmed === 'false') return false;
  if (trimmed === 'null') return null;
  
  // JSONè§£æ
  try {
    return JSON.parse(trimmed);
  } catch (e) {
    // å¯¹è±¡/æ•°ç»„çš„ç‰¹æ®Šå¤„ç†
    if ((trimmed.startsWith('{') && trimmed.endsWith('}')) || 
        (trimmed.startsWith('[') && trimmed.endsWith(']'))) {
      try {
        return new Function(`return ${trimmed};`)();
      } catch (err) { }
    }
  }
  
  // å­—ç¬¦ä¸²å¤„ç†ï¼ˆå»é™¤å¼•å·ï¼‰
  return this._trimQuotes(valStr);
}
```

### 8.2 MVUçŠ¶æ€æ›´æ–°æ‰§è¡Œ

#### 8.2.1 å‘½ä»¤æ‰§è¡Œå¼•æ“
```javascript
async executeMVUCommands(aiResponse) {
  const inputData = { old_variables: this.currentMvuState };
  
  try {
    // è°ƒç”¨åç«¯MVUè„šæœ¬
    await eventEmit('mag_invoke_mvu', aiResponse, inputData);
    
    if (inputData.new_variables) {
      this.currentMvuState = inputData.new_variables;
      return inputData.new_variables;
    }
  } catch (error) {
    console.error('MVUè„šæœ¬æ‰§è¡Œå¤±è´¥:', error);
    // å¯ç”¨å‰ç«¯å¤‡ç”¨å¤„ç†å™¨
    return this._applyUpdateFallback(aiResponse, this.currentMvuState);
  }
}
```

#### 8.2.2 å‰ç«¯å¤‡ç”¨å¤„ç†å™¨
```javascript
_applyUpdateFallback(script, currentMvuState) {
  const newState = _.cloneDeep(currentMvuState);
  const commands = this._extractCommands(script);
  let modified = false;
  
  for (const command of commands) {
    try {
      const path = this._trimQuotes(command.args[0]);
      
      switch (command.command) {
        case 'set':
          const newValue = this._parseCommandValue(command.args[1]);
          _.set(newState.stat_data, path, newValue);
          modified = true;
          break;
          
        case 'add':
          const currentValue = _.get(newState.stat_data, path);
          const delta = this._parseCommandValue(command.args[1]);
          if (typeof currentValue === 'number' && typeof delta === 'number') {
            _.set(newState.stat_data, path, currentValue + delta);
            modified = true;
          }
          break;
          
        case 'remove':
          _.unset(newState.stat_data, path);
          modified = true;
          break;
      }
    } catch (e) {
      console.error('å¤„ç†æŒ‡ä»¤å¤±è´¥:', command, e);
    }
  }
  
  return modified ? newState : null;
}
```

### 8.3 çŠ¶æ€åŒæ­¥ä¸éªŒè¯

#### 8.3.1 çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥
```javascript
async validateStateConsistency() {
  try {
    // è·å–æƒå¨çŠ¶æ€
    const messages = await getChatMessages(getCurrentMessageId());
    const authoritativeState = messages[0].data;
    
    // æ¯”è¾ƒæœ¬åœ°ç¼“å­˜
    if (!_.isEqual(this.currentMvuState.stat_data, authoritativeState.stat_data)) {
      console.warn('[çŠ¶æ€åŒæ­¥] æ£€æµ‹åˆ°ä¸ä¸€è‡´ï¼Œè¿›è¡Œä¿®æ­£...');
      this.currentMvuState = authoritativeState;
      this.renderUI(authoritativeState.stat_data);
      return false;
    }
    return true;
  } catch (error) {
    console.error('[çŠ¶æ€åŒæ­¥] éªŒè¯å¤±è´¥:', error);
    return false;
  }
}
```

## ç¬¬ä¹ç« ï¼šMVUæ•°æ®ç»“æ„ä¸æ“ä½œæ–¹æ³•è®º

### 9.1 ValueWithDescriptionæ¨¡å¼

#### 9.1.1 æ•°æ®ç»“æ„è®¾è®¡åŸç†
MVUç³»ç»Ÿé‡‡ç”¨`[å€¼, "æè¿°"]`çš„äºŒå…ƒç»„æ¨¡å¼ï¼Œå®ç°æ•°æ®ä¸å…ƒä¿¡æ¯çš„ç»Ÿä¸€å­˜å‚¨ï¼š

```javascript
// åŸºç¡€æ ¼å¼
"å±æ€§å": [å®é™…å€¼, "å±æ€§æè¿°å’ŒåŠŸèƒ½è¯´æ˜"]

// å®é™…åº”ç”¨
"æ³•åŠ›": [100, "ã€å››ç»´èƒ½åŠ›åŸºçŸ³ã€‘å†³å®šè§’è‰²çš„æ³•åŠ›ä¸Šé™"],
"å½“å‰å¢ƒç•Œ": ["ç»ƒæ°”ä¸€å±‚", "ã€ä¿®ä¸ºæ ¸å¿ƒé©±åŠ¨ã€‘è§’è‰²çš„å½“å‰ä¿®ä¸ºå¢ƒç•Œåç§°"]
```

**è®¾è®¡ä¼˜åŠ¿**ï¼š
- æ•°æ®è‡ªæè¿°ï¼šæ¯ä¸ªå˜é‡éƒ½åŒ…å«å…¶åŠŸèƒ½è¯´æ˜
- ç±»å‹ç»Ÿä¸€ï¼šç»Ÿä¸€çš„è®¿é—®æ¨¡å¼ï¼Œç®€åŒ–ä»£ç é€»è¾‘
- æ‰©å±•å‹å¥½ï¼šæè¿°ä¿¡æ¯ä¸ºAIæä¾›ä¸Šä¸‹æ–‡ï¼Œä¾¿äºæ™ºèƒ½æ“ä½œ

#### 9.1.2 SafeGetValueç»Ÿä¸€è®¿é—®ç­–ç•¥
```javascript
// ç»Ÿä¸€å¤„ç†æ•°ç»„å’Œç›´æ¥å€¼ä¸¤ç§æƒ…å†µ
SafeGetValue(obj, path, defaultValue = 'N/A') {
  // ... è·¯å¾„è§£æé€»è¾‘
  
  if (Array.isArray(current) && current.length > 0) {
    const actualValue = current[0];
    if (typeof actualValue === 'boolean') return actualValue;
    return String(actualValue);
  }
  
  if (typeof current === 'boolean') return current;
  return String(current);
}
```

### 9.2 Schemaé©±åŠ¨çš„æ‰©å±•æ€§æ§åˆ¶

#### 9.2.1 $metaæ‰©å±•æ€§æ ‡è®°
```javascript
// Schemaé¡¶å±‚æ§åˆ¶
{
  "$meta": {
    "extensible": true
  },
  // å˜é‡å®šä¹‰...
}
```

#### 9.2.2 $__META_EXTENSIBLE__$åˆ—è¡¨æ ‡è®°
```javascript
// å¯æ‰©å±•åˆ—è¡¨çš„æ ‡å‡†æ ¼å¼
"å¯æ‰©å±•åˆ—è¡¨å": [
  [ç°æœ‰å…ƒç´ 1, ç°æœ‰å…ƒç´ 2, "$__META_EXTENSIBLE__$"],
  "åˆ—è¡¨åŠŸèƒ½æè¿°"
]

// æ£€æŸ¥æ˜¯å¦å¯æ‰©å±•
const isExtensible = Array.isArray(listData) &&
                    listData.includes('$__META_EXTENSIBLE__$');
```

### 9.3 å¤šå±‚æŒä¹…åŒ–ç­–ç•¥

#### 9.3.1 æ•°æ®å­˜å‚¨å±‚æ¬¡
```javascript
// ç¬¬ä¸€å±‚ï¼šå†…å­˜ç¼“å­˜ï¼ˆæœ€å¿«è®¿é—®ï¼‰
this.currentMvuState = newMvuData;

// ç¬¬äºŒå±‚ï¼šSillyTavernæ¶ˆæ¯æ•°æ®ï¼ˆæƒå¨æºï¼‰
messages[0].data = newMvuData;
await TavernHelper.setChatMessages([messages[0]]);

// ç¬¬ä¸‰å±‚ï¼šlocalStorageå¤‡ä»½ï¼ˆç¦»çº¿æ¢å¤ï¼‰
localStorage.setItem('guixu_last_good_state', JSON.stringify(newMvuData));

// ç¬¬å››å±‚ï¼šä¸–ç•Œä¹¦æŒä¹…åŒ–ï¼ˆäººç±»å¯è¯»ï¼‰
await this.writeToLorebook('çŠ¶æ€å¿«ç…§', JSON.stringify(newMvuData));
```

#### 9.3.2 æ•°æ®åŒæ­¥ä¼˜å…ˆçº§
```javascript
// æ•°æ®æºä¼˜å…ˆçº§ï¼ˆä»é«˜åˆ°ä½ï¼‰
const dataSourcePriority = [
  'MVUè„šæœ¬æ‰§è¡Œç»“æœ',    // æœ€é«˜ä¼˜å…ˆçº§
  'SillyTavernæ¶ˆæ¯æ•°æ®', // æŒä¹…åŒ–æƒå¨æº
  'å‰ç«¯å†…å­˜ç¼“å­˜',        // ä¸´æ—¶å¿«é€Ÿè®¿é—®
  'localStorageå¤‡ä»½',    // æœ¬åœ°æ¢å¤å¤‡ä»½
  'é»˜è®¤åˆå§‹å€¼'          // æœ€åå…œåº•
];
```

### 9.4 å‘½ä»¤è§„èŒƒä¸æœ€ä½³å®è·µ

#### 9.4.1 MVUå‘½ä»¤æ ‡å‡†æ ¼å¼
```javascript
// è®¾ç½®å•ä¸ªå€¼
_.set('å½“å‰å¢ƒç•Œ', 'ç­‘åŸºä¸€å±‚');

// ä¿®æ”¹æ•°ç»„å€¼ï¼ˆä¿æŒæè¿°ä¸å˜ï¼‰
_.set('æ³•åŠ›.0', 200);  // åªä¿®æ”¹å€¼ï¼Œä¿æŒæè¿°

// æ·»åŠ æ•°å€¼
_.add('å½“å‰æ³•åŠ›', -50);  // æ¶ˆè€—æ³•åŠ›

// è£…å¤‡ç‰©å“
_.set('æ­¦å™¨', [{
  id: 'sword_001',
  name: 'é’é’¢å‰‘',
  tier: 'ç­‘åŸº',
  attributes_bonus: {'æ³•åŠ›': 20, 'ç©ºé€Ÿ': 5}
}]);

// æ·»åŠ åˆ°å¯æ‰©å±•åˆ—è¡¨
_.assign('å¤©èµ‹åˆ—è¡¨.0', newTalentObject);
```

#### 9.4.2 æ•°æ®æ“ä½œå®‰å…¨å‡†åˆ™
```javascript
// 1. å§‹ç»ˆæ£€æŸ¥è·¯å¾„å­˜åœ¨æ€§
if (_.has(data, path)) {
  _.set(data, path, newValue);
}

// 2. ä¿æŒæ•°ç»„æ ¼å¼çš„ä¸€è‡´æ€§
const currentValue = _.get(data, path);
if (Array.isArray(currentValue)) {
  _.set(data, `${path}.0`, newValue); // åªæ›´æ–°å€¼éƒ¨åˆ†
}

// 3. éªŒè¯æ•°æ®ç±»å‹
if (typeof newValue === typeof oldValue) {
  _.set(data, path, newValue);
}
```

## ç¬¬åç« ï¼šMVUå¼€å‘å®è·µæŒ‡å—

### 10.1 å¼€å‘ç¯å¢ƒé…ç½®

#### 10.1.1 å¿…å¤‡å·¥å…·å’Œä¾èµ–
```javascript
// æ ¸å¿ƒä¾èµ–
- SillyTavernç¯å¢ƒ
- TavernHelperæ‰©å±•
- lodashåº“ï¼ˆç”¨äºæ·±åº¦æ“ä½œï¼‰
- ç°ä»£æµè§ˆå™¨ï¼ˆæ”¯æŒES6+ï¼‰

// å¼€å‘å·¥å…·
- VSCode + ç›¸å…³æ’ä»¶
- æµè§ˆå™¨å¼€å‘è€…å·¥å…·
- SillyTavernè°ƒè¯•æ¨¡å¼
```

#### 10.1.2 è°ƒè¯•é…ç½®
```javascript
// å¯ç”¨è¯¦ç»†æ—¥å¿—
const DEBUG_MODE = true;

if (DEBUG_MODE) {
  console.log('[å½’å¢Ÿè°ƒè¯•] MVUçŠ¶æ€å˜æ›´:', oldState, '=>', newState);
  console.log('[å½’å¢Ÿè°ƒè¯•] æ‰§è¡Œçš„æŒ‡ä»¤:', extractedCommands);
  console.log('[å½’å¢Ÿè°ƒè¯•] UIæ›´æ–°ç»“æœ:', renderResult);
}
```

### 10.2 ä»£ç ç»„ç»‡æ¨¡å¼

#### 10.2.1 æ¨¡å—åŒ–æ¶æ„
```javascript
// æ ¸å¿ƒç®¡ç†å™¨
const GuixuManager = {
  // æ•°æ®å±‚
  currentMvuState: null,
  baseAttributes: {},
  
  // UIå±‚
  renderUI(data) { /* æ¸²æŸ“é€»è¾‘ */ },
  updateAttributes() { /* å±æ€§æ›´æ–° */ },
  
  // ä¸šåŠ¡å±‚
  equipItem(item) { /* è£…å¤‡é€»è¾‘ */ },
  useItem(item) { /* ä½¿ç”¨é€»è¾‘ */ },
  
  // æŒä¹…åŒ–å±‚
  saveState() { /* ä¿å­˜é€»è¾‘ */ },
  loadState() { /* åŠ è½½é€»è¾‘ */ }
};
```

### 10.3 å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ

#### 10.3.1 æ•°æ®åŒæ­¥é—®é¢˜
```javascript
// é—®é¢˜ï¼šå‰ç«¯ä¸åç«¯çŠ¶æ€ä¸ä¸€è‡´
// è§£å†³æ–¹æ¡ˆï¼šå®šæœŸéªŒè¯å’Œä¿®æ­£
async function validateDataSync() {
  const frontendState = GuixuManager.currentMvuState;
  const backendState = await getCurrentMVUState();
  
  if (!_.isEqual(frontendState, backendState)) {
    console.warn('[çŠ¶æ€åŒæ­¥] å‘ç°ä¸ä¸€è‡´ï¼Œè¿›è¡Œä¿®æ­£');
    GuixuManager.currentMvuState = backendState;
    GuixuManager.renderUI(backendState.stat_data);
  }
}

// æ¯30ç§’éªŒè¯ä¸€æ¬¡
setInterval(validateDataSync, 30000);
```

### 10.4 æ€§èƒ½ä¼˜åŒ–æŒ‡å—

#### 10.4.1 æ¸²æŸ“ä¼˜åŒ–
```javascript
// é˜²æŠ–æ¸²æŸ“ï¼Œé¿å…é¢‘ç¹æ›´æ–°
const debouncedRender = _.debounce((data) => {
  GuixuManager.renderUI(data);
}, 100);

// è™šæ‹ŸDOMå·®å¼‚æ›´æ–°
function updateElementIfChanged(element, newContent) {
  if (element.innerHTML !== newContent) {
    element.innerHTML = newContent;
  }
}
```

## ç¬¬åä¸€ç« ï¼šå‰ç«¯HTMLä¸MVUå˜é‡äº¤äº’æœºåˆ¶è®°å¿†é“¶è¡Œ

### 11.1 æ ¸å¿ƒäº¤äº’æ¶æ„æ¦‚è§ˆ

æ ¹æ®`src/å½’å¢Ÿplus/index.html`å’Œ`mvuå˜é‡ä¹‹å‰.txt`çš„æ·±åº¦åˆ†æï¼Œå½’å¢ŸPlusç³»ç»Ÿå®ç°äº†å®Œæ•´çš„å‰ç«¯-MVUæ•°æ®ç»‘å®šæ¶æ„ã€‚

#### 11.1.1 GuixuManagerå•ä¾‹æ¨¡å¼ä¸MVUçŠ¶æ€ç®¡ç†
```javascript
const GuixuManager = {
  currentMvuState: null, // ç¼“å­˜å½“å‰æœ€æ–°çš„mvuçŠ¶æ€
  baseAttributes: {}, // å­˜å‚¨ä»mvuåŠ è½½çš„åŸå§‹å±æ€§
  equippedItems: {    // è£…å¤‡çŠ¶æ€ç®¡ç†
    wuqi: null, fangju: null, shipin: null,
    fabao1: null, zhuxiuGongfa: null, fuxiuXinfa: null
  },
  pendingActions: [], // æŒ‡ä»¤é˜Ÿåˆ—
  
  // æ ¸å¿ƒäº¤äº’å‡½æ•°
  async updateDynamicData() {
    const messages = await getChatMessages(getCurrentMessageId());
    this.currentMvuState = messages[0].data; // ç¼“å­˜å®Œæ•´MVUçŠ¶æ€
    this.renderUI(this.currentMvuState.stat_data);
  }
}
```

#### 11.1.2 MVUå˜é‡ç»“æ„ä¸å‰ç«¯å…ƒç´ æ˜ å°„
åŸºäº`mvuå˜é‡ä¹‹å‰.txt`çš„å˜é‡å®šä¹‰ï¼Œå»ºç«‹äº†å®Œæ•´çš„æ•°æ®ç»‘å®šå…³ç³»ï¼š

| MVUå˜é‡è·¯å¾„ | HTML Element ID | æ•°æ®æ ¼å¼ | å‰ç«¯å¤„ç†é€»è¾‘ |
|------------|----------------|----------|-------------|
| `å½“å‰å¢ƒç•Œ.0` | `val-jingjie` | `["ç»ƒæ°”ä¸€å±‚", "æè¿°"]` | æå–å€¼+å“é˜¶æ ·å¼ |
| `å½“å‰æ—¶é—´çºªå¹´.0` | `val-jinian` | `["ç„æ˜Šå†1å¹´1æœˆ1æ—¥", "æè¿°"]` | ç›´æ¥æ˜¾ç¤º |
| `å½’å¢Ÿå……èƒ½æ—¶é—´.0` | `val-guixu-charge-text`, `bar-guixu-charge` | `[0.0001, "æè¿°"]` | ç™¾åˆ†æ¯”+CSSè¿›åº¦æ¡ |
| `æ³•åŠ›.0` / `å½“å‰æ³•åŠ›.0` | `attr-fali` | `[100, "æè¿°"]` | "å½“å‰/ä¸Šé™"æ ¼å¼ |
| `çµæ ¹` | `talent-linggen-list` | `[{åç§°, å“é˜¶, æè¿°}, "è¯´æ˜"]` | å¯å±•å¼€è¯¦æƒ…ç»„ä»¶ |
| `æ­¦å™¨` | `equip-wuqi` | `[null]` æˆ– `[è£…å¤‡å¯¹è±¡]` | è£…å¤‡æ§½ä½æ˜¾ç¤º |

### 11.2 æ•°æ®ç»‘å®šæ ¸å¿ƒæœºåˆ¶

#### 11.2.1 SafeGetValueç»Ÿä¸€è®¿é—®å±‚
```javascript
SafeGetValue(obj, path, defaultValue = 'N/A') {
  // è·¯å¾„è§£ææ”¯æŒ "çµæ ¹.åç§°" æ ¼å¼
  let keys = Array.isArray(path) ? path : path.split('.');
  let current = obj;
  
  for (let i = 0; i < keys.length; i++) {
    if (!current?.hasOwnProperty(keys[i])) {
      return defaultValue;
    }
    current = current[keys[i]];
  }
  
  // å¤„ç†MVUçš„ [å€¼, "æè¿°"] æ ¼å¼
  if (Array.isArray(current) && current.length > 0) {
    const actualValue = current[0];
    return typeof actualValue === 'boolean' ? actualValue : String(actualValue);
  }
  
  return typeof current === 'boolean' ? current : String(current);
}
```

#### 11.2.2 è£…å¤‡ç³»ç»ŸåŒå‘ç»‘å®š
```javascript
// ä»MVUåŠ è½½è£…å¤‡çŠ¶æ€
loadEquipmentFromMVU(data) {
  const equipmentMap = {
    'æ­¦å™¨': 'wuqi', 'ä¸»ä¿®åŠŸæ³•': 'zhuxiuGongfa', 'è¾…ä¿®å¿ƒæ³•': 'fuxiuXinfa',
    'é˜²å…·': 'fangju', 'é¥°å“': 'shipin', 'æ³•å®æ 1': 'fabao1'
  };
  
  for (const [mvuKey, slotKey] of Object.entries(equipmentMap)) {
    const slot = document.getElementById(`equip-${slotKey}`);
    const itemArray = _.get(data, mvuKey, null);
    const item = Array.isArray(itemArray) && itemArray.length > 0 ? itemArray[0] : null;
    
    if (item && typeof item === 'object') {
      const tier = this.SafeGetValue(item, 'tier', 'å‡¡å“');
      slot.textContent = this.SafeGetValue(item, 'name');
      slot.setAttribute('style', this.getTierStyle(tier));
      slot.classList.add('equipped');
      slot.dataset.itemDetails = JSON.stringify(item);
    } else {
      slot.textContent = defaultTextMap[slotKey];
      slot.classList.remove('equipped');
    }
  }
}
```

### 11.3 UIæ¸²æŸ“ä¸æ•°æ®ç»‘å®šæ–¹æ³•è®º

#### 11.3.1 å“é˜¶æ ·å¼åŠ¨æ€æ¸²æŸ“ç³»ç»Ÿ
```javascript
getTierStyle(tier) {
  const animatedStyle = 'background-size: 200% auto; -webkit-background-clip: text; background-clip: text; color: transparent; animation: god-tier-animation 3s linear infinite; font-weight: bold;';
  
  const styles = {
    ç»ƒæ°”: 'color: #FFFFFF;',
    ç­‘åŸº: 'color: #66CDAA;',
    é‡‘ä¸¹: 'color: #FFD700;',
    å…ƒå©´: `background: linear-gradient(90deg, #DA70D6, #BA55D3, #9932CC, #BA55D3, #DA70D6); ${animatedStyle}`,
    åŒ–ç¥: `background: linear-gradient(90deg, #DC143C, #FF4500, #B22222, #FF4500, #DC143C); ${animatedStyle}`,
    // ... æ›´å¤šå“é˜¶æ ·å¼
  };
  
  return (styles[tier] || 'color: #e0dcd1;') + 'font-style: italic;';
}
```

#### 11.3.2 å¤æ‚å¯¹è±¡æ¸²æŸ“ç­–ç•¥
```javascript
updateTalentAndLinggen(data) {
  const container = document.getElementById('talent-linggen-list');
  container.innerHTML = '';
  
  // 1. å¤„ç†çµæ ¹å¯¹è±¡
  const linggenData = _.get(data, 'çµæ ¹.0', null);
  if (linggenData && typeof linggenData === 'object') {
    const name = this.SafeGetValue(linggenData, 'åç§°', 'æœªçŸ¥çµæ ¹');
    const tier = this.SafeGetValue(linggenData, 'å“é˜¶', 'å‡¡å“');
    const description = this.SafeGetValue(linggenData, 'æè¿°', 'æ— æè¿°');
    const tierStyle = this.getTierColorStyle(tier);
    
    html += `
      <details class="details-container">
        <summary>
          <span class="attribute-name">çµæ ¹</span>
          <span class="attribute-value" style="${tierStyle}">ã€${tier}ã€‘ ${name}</span>
        </summary>
        <div class="details-content">
          <p>${description}</p>
        </div>
      </details>
    `;
  }
  
  // 2. å¤„ç†å¤©èµ‹åˆ—è¡¨
  const tianfuList = _.get(data, 'å¤©èµ‹åˆ—è¡¨.0', []);
  if (Array.isArray(tianfuList) && tianfuList[0] !== '$__META_EXTENSIBLE__$') {
    tianfuList.forEach(rawTianfu => {
      try {
        const tianfu = typeof rawTianfu === 'string' ? JSON.parse(rawTianfu) : rawTianfu;
        // æ¸²æŸ“å¤©èµ‹å¯¹è±¡...
      } catch (e) {
        console.error('è§£æå¤©èµ‹å¤±è´¥:', rawTianfu, e);
      }
    });
  }
  
  container.innerHTML = html;
}
```

### 11.4 å‰åç«¯é€šä¿¡åè®®

#### 11.4.1 æŒ‡ä»¤ç”Ÿæˆä¸ä¼ è¾“æœºåˆ¶
```javascript
async handleAction(userMessage = '') {
  // 1. æ•´åˆç”¨æˆ·è¾“å…¥å’Œç³»ç»ŸæŒ‡ä»¤
  let commandText = '';
  if (this.pendingActions.length > 0) {
    commandText += '[æœ¬è½®è¡ŒåŠ¨æŒ‡ä»¤]\n';
    this.pendingActions.forEach(cmd => {
      switch (cmd.action) {
        case 'equip': commandText += `è£…å¤‡ [${cmd.itemName}] åˆ° [${cmd.category}] æ§½ä½ã€‚\n`; break;
        case 'unequip': commandText += `å¸ä¸‹ [${cmd.itemName}] ä» [${cmd.category}] æ§½ä½ã€‚\n`; break;
        case 'use': commandText += `ä½¿ç”¨ ${cmd.quantity} ä¸ª [${cmd.itemName}]ã€‚\n`; break;
      }
    });
  }
  
  // 2. æ„å»ºAIç”Ÿæˆé…ç½®
  const generateConfig = {
    injects: [{
      role: 'user',
      content: commandText + (userMessage ? `<è¡ŒåŠ¨é€‰æ‹©>\n${userMessage}\n</è¡ŒåŠ¨é€‰æ‹©>` : ''),
      position: 'in_chat',
      should_scan: true
    }],
    should_stream: false
  };
  
  // 3. è°ƒç”¨AIç”Ÿæˆå¹¶å¤„ç†MVUæ›´æ–°
  const aiResponse = await TavernHelper.generate(generateConfig);
  const inputData = { old_variables: this.currentMvuState };
  
  try {
    await eventEmit('mag_invoke_mvu', aiResponse, inputData);
    if (inputData.new_variables) {
      this.currentMvuState = inputData.new_variables;
      this.renderUI(this.currentMvuState.stat_data);
    }
  } catch (mvuError) {
    // å¯ç”¨å‰ç«¯å¤‡ç”¨å¤„ç†å™¨
    const fallbackState = this._applyUpdateFallback(aiResponse, this.currentMvuState);
    if (fallbackState) {
      this.currentMvuState = fallbackState;
      this.renderUI(fallbackState.stat_data);
    }
  }
  
  // 4. åŒå±‚æ¸¸ç©æœºåˆ¶ï¼šé™é»˜æ›´æ–°ç¬¬0å±‚
  const messages = await getChatMessages('0');
  messages[0].message = aiResponse;
  messages[0].data = this.currentMvuState;
  await TavernHelper.setChatMessages([messages[0]], { refresh: 'none' });
}
```

#### 11.4.2 çŠ¶æ€åŒæ­¥ä¸é”™è¯¯æ¢å¤
```javascript
// ä¸‰å±‚å®¹é”™æœºåˆ¶
async handleAction() {
  try {
    // ç¬¬ä¸€å±‚ï¼šæ­£å¸¸MVUè„šæœ¬æ‰§è¡Œ
    await eventEmit('mag_invoke_mvu', aiResponse, inputData);
  } catch (mvuError) {
    try {
      // ç¬¬äºŒå±‚ï¼šå‰ç«¯å¤‡ç”¨å¤„ç†å™¨
      const fallbackState = this._applyUpdateFallback(aiResponse, this.currentMvuState);
      if (fallbackState) {
        this.currentMvuState = fallbackState;
        return;
      }
    } catch (fallbackError) {
      // ç¬¬ä¸‰å±‚ï¼šçŠ¶æ€å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šçŠ¶æ€
      const backupState = localStorage.getItem('guixu_last_good_state');
      if (backupState) {
        this.currentMvuState = JSON.parse(backupState);
        this.renderUI(this.currentMvuState.stat_data);
      }
    }
  }
}
```

## ç¬¬åäºŒç« ï¼šæ•°æ®æµå‘ä¸çŠ¶æ€åŒæ­¥ç­–ç•¥è®°å¿†é“¶è¡Œ

### 12.1 å®Œæ•´æ•°æ®æµå‘æ¶æ„

#### 12.1.1 åˆå§‹åŒ–é˜¶æ®µæ•°æ®æµ
```
é¡µé¢åŠ è½½ â†’ APP_READYäº‹ä»¶ â†’ GuixuManager.init()
    â†“
updateDynamicData() â†’ getChatMessages(getCurrentMessageId())
    â†“
messages[0].data â†’ currentMvuStateç¼“å­˜ â†’ renderUI(stat_data)
    â†“
loadAutoWriteState() + loadEquipmentState() + loadPendingActions()
    â†“
ç•Œé¢å®Œå…¨å°±ç»ª
```

#### 12.1.2 ç”¨æˆ·äº¤äº’é˜¶æ®µæ•°æ®æµ
```
ç”¨æˆ·æ“ä½œ(è£…å¤‡/ä½¿ç”¨ç‰©å“) â†’ å‰ç«¯ä¹è§‚æ›´æ–° â†’ pendingActionsé˜Ÿåˆ—
    â†“
handleAction() â†’ æ„å»ºGenerateConfig â†’ TavernHelper.generate()
    â†“
AIå›å¤ â†’ eventEmit('mag_invoke_mvu') â†’ MVUè„šæœ¬æ‰§è¡Œ
    â†“
new_variables â†’ currentMvuStateæ›´æ–° â†’ renderUI()
    â†“
ç¬¬0å±‚ä¿å­˜(åŒå±‚æ¸¸ç©) â†’ localStorageå¤‡ä»½ â†’ çŠ¶æ€å®Œå…¨åŒæ­¥
```

### 12.2 æ ¸å¿ƒçŠ¶æ€åŒæ­¥ç­–ç•¥

#### 12.2.1 ä¹è§‚æ›´æ–°æ¨¡å¼
```javascript
equipItem(item, category, buttonElement) {
  // ç«‹å³æ›´æ–°å‰ç«¯æ˜¾ç¤ºï¼ˆä¹è§‚æ›´æ–°ï¼‰
  this.equippedItems[slotKey] = item;
  slotElement.textContent = item.name;
  slotElement.classList.add('equipped');
  this.updateDisplayedAttributes(); // ç«‹å³é‡æ–°è®¡ç®—å±æ€§
  
  // æ·»åŠ åˆ°å¾…å¤„ç†é˜Ÿåˆ—
  this.pendingActions.push({
    action: 'equip',
    itemName: item.name,
    category: slotFriendlyName
  });
  
  // æœ¬åœ°çŠ¶æ€æŒä¹…åŒ–
  this.saveEquipmentState();
  this.savePendingActions();
}
```

#### 12.2.2 æƒå¨ç¡®è®¤åŒæ­¥
```javascript
async executeActions() {
  // AIå¤„ç†åçš„æƒå¨çŠ¶æ€æ›´æ–°
  const inputData = { old_variables: this.currentMvuState };
  await eventEmit('mag_invoke_mvu', aiResponse, inputData);
  
  if (inputData.new_variables) {
    // ä»¥MVUè„šæœ¬æ‰§è¡Œç»“æœä¸ºå‡†ï¼Œè¦†ç›–å‰ç«¯ä¹è§‚æ›´æ–°
    this.currentMvuState = inputData.new_variables;
    this.renderUI(this.currentMvuState.stat_data);
    
    // å¦‚æœæƒå¨çŠ¶æ€ä¸å‰ç«¯çŠ¶æ€ä¸ä¸€è‡´ï¼Œè¿›è¡Œä¿®æ­£
    this.validateAndFixEquipmentState();
  }
}
```

### 12.3 é”™è¯¯æ¢å¤ä¸å¤‡ä»½æœºåˆ¶

#### 12.3.1 å¤šå±‚å¤‡ä»½ç­–ç•¥
```javascript
// ç¬¬ä¸€å±‚ï¼šå®æ—¶å†…å­˜å¤‡ä»½
beforeStateChange() {
  this.stateBackup = _.cloneDeep(this.currentMvuState);
}

// ç¬¬äºŒå±‚ï¼šlocalStorageå®šæœŸå¤‡ä»½
backupToLocalStorage() {
  localStorage.setItem('guixu_backup_state', JSON.stringify({
    state: this.currentMvuState,
    timestamp: Date.now()
  }));
}

// ç¬¬ä¸‰å±‚ï¼šSillyTavernæ¶ˆæ¯æŒä¹…åŒ–
async backupToMessages() {
  const messages = await getChatMessages('0');
  messages[0].data = this.currentMvuState;
  await TavernHelper.setChatMessages([messages[0]], { refresh: 'none' });
}
```

#### 12.3.2 çŠ¶æ€ä¸€è‡´æ€§éªŒè¯
```javascript
async validateStateConsistency() {
  // å®šæœŸéªŒè¯å‰ç«¯çŠ¶æ€ä¸æƒå¨æºçš„ä¸€è‡´æ€§
  const messages = await getChatMessages(getCurrentMessageId());
  const authoritativeState = messages[0].data;
  
  if (!_.isEqual(this.currentMvuState.stat_data, authoritativeState.stat_data)) {
    console.warn('[çŠ¶æ€åŒæ­¥] æ£€æµ‹åˆ°ä¸ä¸€è‡´ï¼Œè¿›è¡Œä¿®æ­£');
    
    // ä»¥æƒå¨çŠ¶æ€ä¸ºå‡†è¿›è¡Œä¿®æ­£
    this.currentMvuState = authoritativeState;
    this.renderUI(authoritativeState.stat_data);
    this.loadEquipmentState(); // é‡æ–°åŠ è½½è£…å¤‡çŠ¶æ€
    
    return false; // è¡¨ç¤ºè¿›è¡Œäº†ä¿®æ­£
  }
  return true; // çŠ¶æ€ä¸€è‡´
}

// æ¯30ç§’éªŒè¯ä¸€æ¬¡çŠ¶æ€ä¸€è‡´æ€§
setInterval(() => this.validateStateConsistency(), 30000);
```

è¿™å¥—å®Œæ•´çš„è®°å¿†é“¶è¡Œå’Œæ–¹æ³•è®ºæ€»ç»“ä¸ºå½’å¢ŸPlusé¡¹ç›®çš„MVUç³»ç»Ÿæä¾›äº†ï¼š

1. **å®Œæ•´çš„æ¶æ„æ–‡æ¡£**ï¼šä»å‰ç«¯UIåˆ°MVUå˜é‡çš„å…¨é“¾è·¯åˆ†æ
2. **æ•°æ®ç»‘å®šæœºåˆ¶**ï¼šSafeGetValueæ¨¡å¼å’ŒåŒå‘ç»‘å®šå®ç°
3. **çŠ¶æ€åŒæ­¥ç­–ç•¥**ï¼šä¹è§‚æ›´æ–°+æƒå¨ç¡®è®¤+å¤šå±‚å¤‡ä»½çš„å®Œæ•´æ–¹æ¡ˆ
4. **é”™è¯¯æ¢å¤æœºåˆ¶**ï¼šä¸‰å±‚å®¹é”™+çŠ¶æ€å›æ»š+ä¸€è‡´æ€§éªŒè¯
5. **å¼€å‘å®è·µæŒ‡å—**ï¼šè°ƒè¯•ã€æµ‹è¯•ã€ç»´æŠ¤çš„å®Œæ•´æ–¹æ³•è®º

ç¡®ä¿äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ã€æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

## ç¬¬åä¸‰ç« ï¼šå‰ç«¯UIç»„ä»¶è¯¦ç»†æ¶æ„ä¸äº¤äº’æœºåˆ¶

### 13.1 è§†å›¾åˆ‡æ¢ç³»ç»Ÿ

#### 13.1.1 ç§»åŠ¨ç«¯é€‚é…æœºåˆ¶
```javascript
// è§†å›¾åˆ‡æ¢æ ¸å¿ƒé€»è¾‘
toggleViewMode() {
  this.isMobileView = !this.isMobileView;
  const container = document.querySelector('.guixu-root-container');
  const btn = document.getElementById('view-toggle-btn');
  
  if (this.isMobileView) {
    container.classList.add('mobile-view');
    btn.textContent = 'ğŸ’»'; // åˆ‡æ¢åˆ°æ¡Œé¢å›¾æ ‡
    btn.title = 'åˆ‡æ¢åˆ°æ¡Œé¢è§†å›¾';
  } else {
    container.classList.remove('mobile-view');
    btn.textContent = 'ğŸ“±'; // åˆ‡æ¢åˆ°æ‰‹æœºå›¾æ ‡
    btn.title = 'åˆ‡æ¢åˆ°ç§»åŠ¨è§†å›¾';
  }
  this.saveViewMode();
}
```

#### 13.1.2 å“åº”å¼å¸ƒå±€ç­–ç•¥
```css
/* æ¡Œé¢è§†å›¾ï¼š3åˆ—ç½‘æ ¼å¸ƒå±€ */
.game-container {
  display: grid;
  grid-template-rows: 65px 1fr auto;
  grid-template-columns: 220px 1fr 160px;
  gap: 1px;
}

/* ç§»åŠ¨è§†å›¾ï¼šå•åˆ—å‚ç›´å¸ƒå±€ */
.mobile-view .game-container {
  grid-template-columns: 1fr;
  grid-template-rows: auto 1fr auto auto auto;
}
```

### 13.2 æ¨¡æ€æ¡†ç®¡ç†ç³»ç»Ÿ

#### 13.2.1 ç»Ÿä¸€æ¨¡æ€æ¡†æ§åˆ¶å™¨
```javascript
// æ¨¡æ€æ¡†ç”Ÿå‘½å‘¨æœŸç®¡ç†
const ModalManager = {
  openModal(modalId) {
    this.closeAllModals(); // ç¡®ä¿åŒæ—¶åªæœ‰ä¸€ä¸ªæ¨¡æ€æ¡†
    const modal = document.getElementById(modalId);
    if (modal) modal.style.display = 'flex';
  },
  
  closeAllModals() {
    document.querySelectorAll('.modal-overlay').forEach(modal => {
      modal.style.display = 'none';
    });
  },
  
  // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
  showCustomConfirm(message, onConfirm) {
    const modal = document.getElementById('custom-confirm-modal');
    const messageEl = document.getElementById('custom-confirm-message');
    messageEl.textContent = message;
    
    // åŠ¨æ€ç»‘å®šç¡®è®¤å›è°ƒ
    const newOkBtn = okBtn.cloneNode(true);
    newOkBtn.addEventListener('click', () => {
      this.closeAllModals();
      if (typeof onConfirm === 'function') onConfirm();
    });
    
    this.openModal('custom-confirm-modal');
  }
};
```

#### 13.2.2 å¼‚æ­¥æ•°æ®åŠ è½½æ¨¡å¼
```javascript
// æ¨¡æ€æ¡†å†…å®¹å¼‚æ­¥åŠ è½½æ¨¡å¼
async showInventory() {
  this.openModal('inventory-modal');
  const body = document.querySelector('#inventory-modal .modal-body');
  
  // 1. æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  body.innerHTML = '<p class="modal-placeholder">æ­£åœ¨æ¸…ç‚¹è¡Œå›Š...</p>';
  
  try {
    // 2. å¼‚æ­¥è·å–æ•°æ®
    const messages = await getChatMessages(getCurrentMessageId());
    const stat_data = messages[0].data.stat_data;
    
    // 3. æ¸²æŸ“å®é™…å†…å®¹
    body.innerHTML = this.renderInventory(stat_data);
  } catch (error) {
    // 4. é”™è¯¯çŠ¶æ€å¤„ç†
    body.innerHTML = `<p class="modal-placeholder">åŠ è½½èƒŒåŒ…æ—¶å‡ºé”™: ${error.message}</p>`;
  }
}
```

### 13.3 è£…å¤‡ç³»ç»ŸUIäº¤äº’

#### 13.3.1 è£…å¤‡æ§½ä½å¯è§†åŒ–
```javascript
// è£…å¤‡çŠ¶æ€å¯è§†åŒ–æ›´æ–°
updateEquipmentSlot(slotKey, item) {
  const slotElement = document.getElementById(`equip-${slotKey}`);
  
  if (item && typeof item === 'object') {
    const tier = this.SafeGetValue(item, 'tier', 'å‡¡å“');
    const tierStyle = this.getTierStyle(tier);
    
    // æ›´æ–°æ˜¾ç¤ºå†…å®¹
    slotElement.textContent = this.SafeGetValue(item, 'name');
    slotElement.setAttribute('style', tierStyle);
    slotElement.classList.add('equipped');
    
    // å­˜å‚¨è¯¦ç»†ä¿¡æ¯ç”¨äºæ‚¬æµ®æç¤º
    slotElement.dataset.itemDetails = JSON.stringify(item);
  } else {
    // æ¸…ç©ºè£…å¤‡æ§½
    slotElement.textContent = defaultTextMap[slotKey];
    slotElement.classList.remove('equipped');
    slotElement.removeAttribute('style');
    delete slotElement.dataset.itemDetails;
  }
}
```

#### 13.3.2 è£…å¤‡æ‚¬æµ®æç¤ºç³»ç»Ÿ
```javascript
// è£…å¤‡è¯¦æƒ…æ‚¬æµ®æç¤º
showEquipmentTooltip(element, event) {
  const tooltip = document.getElementById('equipment-tooltip');
  const itemDataString = element.dataset.itemDetails;
  
  try {
    const item = JSON.parse(itemDataString);
    tooltip.innerHTML = this.renderTooltipContent(item);
    tooltip.style.display = 'block';
    
    // æ™ºèƒ½å®šä½ï¼Œé˜²æ­¢è¶…å‡ºè§†å£
    const tooltipRect = tooltip.getBoundingClientRect();
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    let left = event.pageX + 15;
    let top = event.pageY + 15;
    
    if (left + tooltipRect.width > viewportWidth) {
      left = event.pageX - tooltipRect.width - 15;
    }
    if (top + tooltipRect.height > viewportHeight) {
      top = event.pageY - tooltipRect.height - 15;
    }
    
    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
  } catch (e) {
    console.error('è§£æè£…å¤‡Tooltipæ•°æ®å¤±è´¥:', e);
  }
}
```

### 13.4 èƒŒåŒ…ç³»ç»ŸUIæ¶æ„

#### 13.4.1 åˆ†ç±»æ¸²æŸ“ç­–ç•¥
```javascript
// èƒŒåŒ…åˆ†ç±»æ¸²æŸ“
renderInventory(stat_data) {
  const categories = [
    { title: 'åŠŸæ³•', key: 'åŠŸæ³•åˆ—è¡¨', equipable: true },
    { title: 'æ­¦å™¨', key: 'æ­¦å™¨åˆ—è¡¨', equipable: true },
    { title: 'é˜²å…·', key: 'é˜²å…·åˆ—è¡¨', equipable: true },
    { title: 'é¥°å“', key: 'é¥°å“åˆ—è¡¨', equipable: true },
    { title: 'æ³•å®', key: 'æ³•å®åˆ—è¡¨', equipable: true },
    { title: 'ä¸¹è¯', key: 'ä¸¹è¯åˆ—è¡¨', equipable: false },
    { title: 'æ‚ç‰©', key: 'å…¶ä»–åˆ—è¡¨', equipable: false }
  ];
  
  let html = '';
  categories.forEach(cat => {
    const rawItems = stat_data?.[cat.key]?.[0];
    html += `<details class="inventory-category" open>`;
    html += `<summary class="inventory-category-title">${cat.title}</summary>`;
    
    if (Array.isArray(rawItems) && rawItems.length > 0 && rawItems[0] !== '$__META_EXTENSIBLE__$') {
      html += '<div class="inventory-item-list">';
      rawItems.forEach(rawItem => {
        html += this.renderInventoryItem(rawItem, cat);
      });
      html += '</div>';
    } else {
      html += '<div class="inventory-item-list"><p class="empty-category-text">ç©ºç©ºå¦‚ä¹Ÿ</p></div>';
    }
    html += `</details>`;
  });
  
  return html;
}
```

#### 13.4.2 ç‰©å“æ“ä½œæŒ‰é’®åŠ¨æ€ç”Ÿæˆ
```javascript
// æ ¹æ®ç‰©å“ç±»å‹ç”Ÿæˆæ“ä½œæŒ‰é’®
generateItemActionButtons(item, category) {
  const id = this.SafeGetValue(item, 'id');
  const isEquipped = id ? Object.values(this.equippedItems).some(
    equippedItem => equippedItem && equippedItem.id === id
  ) : false;
  
  let actionButton = '';
  
  if (category.title === 'åŠŸæ³•') {
    // åŠŸæ³•ç‰¹æ®Šå¤„ç†ï¼šä¸»ä¿®/è¾…ä¿®
    const isEquippedAsMain = id && this.equippedItems.zhuxiuGongfa?.id === id;
    const isEquippedAsAux = id && this.equippedItems.fuxiuXinfa?.id === id;
    
    if (isEquippedAsMain) {
      actionButton = `
        <button class="item-unequip-btn" data-slot-id="equip-zhuxiuGongfa">å¸ä¸‹</button>
        <button class="item-equip-btn" data-equip-type="fuxiu" disabled>è¾…ä¿®</button>
      `;
    } else if (isEquippedAsAux) {
      actionButton = `
        <button class="item-equip-btn" data-equip-type="zhuxiu" disabled>ä¸»ä¿®</button>
        <button class="item-unequip-btn" data-slot-id="equip-fuxiuXinfa">å¸ä¸‹</button>
      `;
    } else {
      actionButton = `
        <button class="item-equip-btn" data-equip-type="zhuxiu">ä¸»ä¿®</button>
        <button class="item-equip-btn" data-equip-type="fuxiu">è¾…ä¿®</button>
      `;
    }
  } else if (category.equipable) {
    // æ™®é€šè£…å¤‡
    actionButton = isEquipped ?
      `<button class="item-unequip-btn" data-slot-id="equip-${slotKey}">å¸ä¸‹</button>` :
      `<button class="item-equip-btn">è£…å¤‡</button>`;
  } else if (category.title === 'ä¸¹è¯' || category.title === 'æ‚ç‰©') {
    // æ¶ˆè€—å“
    const quantity = parseInt(this.SafeGetValue(item, 'quantity', 0), 10);
    actionButton = quantity > 0 ?
      `<button class="item-use-btn">ä½¿ç”¨</button>` :
      `<button class="item-use-btn" disabled>å·²ç”¨å®Œ</button>`;
  }
  
  return actionButton;
}
```

## ç¬¬åå››ç« ï¼šé«˜çº§UIäº¤äº’ä¸ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### 14.1 å¿«é€ŸæŒ‡ä»¤ç³»ç»Ÿ

#### 14.1.1 æŒ‡ä»¤é˜Ÿåˆ—å¯è§†åŒ–
```javascript
// å¿«é€ŸæŒ‡ä»¤å¼¹å‡ºèœå•
toggleQuickCommands() {
  const popup = document.getElementById('quick-command-popup');
  
  if (popup.style.display === 'block') {
    this.hideQuickCommands();
  } else {
    this.showQuickCommands();
  }
}

showQuickCommands() {
  const popup = document.getElementById('quick-command-popup');
  
  if (this.pendingActions.length === 0) {
    popup.innerHTML = '<div class="quick-command-empty">æš‚æ— å¾…æ‰§è¡Œçš„æŒ‡ä»¤</div>';
  } else {
    let listHtml = '<ul class="quick-command-list">';
    this.pendingActions.forEach(cmd => {
      let actionText = this.formatActionText(cmd);
      listHtml += `<li class="quick-command-item">${actionText}</li>`;
    });
    listHtml += '</ul>';
    popup.innerHTML = listHtml;
  }
  popup.style.display = 'block';
}
```

#### 14.1.2 æŒ‡ä»¤æ ¼å¼åŒ–ä¸æœ¬åœ°åŒ–
```javascript
// æŒ‡ä»¤æ–‡æœ¬æ ¼å¼åŒ–
formatActionText(cmd) {
  switch (cmd.action) {
    case 'equip':
      return `è£…å¤‡ [${cmd.itemName}] åˆ° [${cmd.category}] æ§½ä½ã€‚`;
    case 'unequip':
      return `å¸ä¸‹ [${cmd.itemName}] ä» [${cmd.category}] æ§½ä½ã€‚`;
    case 'use':
      return `ä½¿ç”¨ ${cmd.quantity} ä¸ª [${cmd.itemName}]ã€‚`;
    default:
      return `æœªçŸ¥æ“ä½œ: ${cmd.action}`;
  }
}
```

### 14.2 æ¶ˆæ¯æç¤ºä¸åé¦ˆç³»ç»Ÿ

#### 14.2.1 ä¸´æ—¶æ¶ˆæ¯æ˜¾ç¤º
```javascript
// ä¸´æ—¶æ¶ˆæ¯å¼¹å‡ºç³»ç»Ÿ
showTemporaryMessage(message, duration = 2000) {
  // æ¸…é™¤å·²å­˜åœ¨çš„æ¶ˆæ¯
  const existingMsg = document.querySelector('.temp-message-popup');
  if (existingMsg) existingMsg.remove();
  
  // åˆ›å»ºæ–°æ¶ˆæ¯å…ƒç´ 
  const msgElement = document.createElement('div');
  msgElement.className = 'temp-message-popup';
  msgElement.textContent = message;
  msgElement.style.cssText = `
    position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
    background: rgba(45, 27, 61, 0.9); color: #c9aa71; padding: 10px 20px;
    border-radius: 5px; z-index: 2000; font-size: 14px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.5); text-align: center;
    transition: opacity 0.5s ease-out;
  `;
  
  document.querySelector('.guixu-root-container').appendChild(msgElement);
  
  // è‡ªåŠ¨æ¶ˆå¤±åŠ¨ç”»
  setTimeout(() => {
    msgElement.style.opacity = '0';
    setTimeout(() => msgElement.remove(), 500);
  }, duration - 500);
}
```

#### 14.2.2 ç­‰å¾…çŠ¶æ€æŒ‡ç¤ºå™¨
```javascript
// ç­‰å¾…æ¶ˆæ¯ç³»ç»Ÿ
waitingMessages: [
  'å‘œå‘œå‘œå‘œä¼Ÿå¤§çš„æ¢¦æ˜Ÿå¤§äººå•Šï¼Œè¯·ç»™ä½ è™”è¯šçš„ä¿¡å¾’{{user}}å›å¤å§......',
  'æ¢¦æ˜Ÿå¤§äººï¼Œæˆ‘ä»¬æ•¬çˆ±ä½ å£ç‰™ï¼ï¼è¯·ç»™æˆ‘å›å¤å§ï¼ï¼',
  'æ¢¦æ˜Ÿå¤§äººæ­£åœ¨å›åº”ä½ çš„è¯·æ±‚ï¼Œä¸ƒä¸ªå·¥ä½œæ—¥ç»™ä½ å›å¤',
  'æ­£åœ¨å‘ä¼Ÿå¤§æ¢¦æ˜Ÿç¥ˆç¥·......å‘œå‘œå‘œä½ å¿«ä¸€ç‚¹å¥½ä¸å¥½'
],

showWaitingMessage() {
  this.hideWaitingMessage(); // ç¡®ä¿åªæœ‰ä¸€ä¸ªå¯è§
  const message = this.waitingMessages[Math.floor(Math.random() * this.waitingMessages.length)];
  const msgElement = document.createElement('div');
  msgElement.id = 'waiting-popup';
  msgElement.className = 'waiting-popup';
  msgElement.innerHTML = `
    <div class="waiting-spinner"></div>
    <span>${message}</span>
  `;
  
  const container = document.querySelector('.guixu-root-container');
  if (container) container.appendChild(msgElement);
}
```

### 14.3 æ–‡æœ¬æ ¼å¼åŒ–ä¸æ¸²æŸ“

#### 14.3.1 æ¸¸æˆæ–‡æœ¬æ ·å¼åŒ–
```javascript
// æ¸¸æˆæ–‡æœ¬æ ¼å¼åŒ–å¤„ç†
formatMessageContent(text) {
  if (!text) return '';
  
  // å¤„ç†æ¢è¡Œç¬¦
  let processedText = text.replace(/\\n/g, '<br />');
  
  // è¯­è¨€æ ·å¼: "..." æˆ– ã€Œ...ã€ -> è§å…‰ç²‰è‰²
  processedText = processedText.replace(/("[^"]+"|ã€Œ[^ã€]+ã€)/g, match => {
    return `<span class="text-language">${match}</span>`;
  });
  
  // å¿ƒç†æ´»åŠ¨: *...* -> åŠé€æ˜ç™½è‰²æ–œä½“
  processedText = processedText.replace(/\*([^*]+)\*/g, (match, p1) => {
    return `<span class="text-psychology">${p1}</span>`;
  });
  
  // æ™¯ç‰©æè¿°: ã€...ã€‘ -> æ·¡ç»¿è‰²ï¼ˆæ’é™¤çº¯æ•°å­—ï¼‰
  processedText = processedText.replace(/ã€([^ã€‘\d]+[^ã€‘]*)ã€‘/g, (match, p1) => {
    return `<span class="text-scenery">${p1}</span>`;
  });
  
  return processedText;
}
```

#### 14.3.2 å“é˜¶æ ·å¼åŠ¨æ€æ¸²æŸ“
```javascript
// å“é˜¶é¢œè‰²ä¸åŠ¨ç”»æ•ˆæœ
getTierStyle(tier) {
  const animatedStyle = `
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    animation: god-tier-animation 3s linear infinite;
    font-weight: bold;
  `;
  
  const styles = {
    ç»ƒæ°”: 'color: #FFFFFF;',
    ç­‘åŸº: 'color: #66CDAA;',
    é‡‘ä¸¹: 'color: #FFD700;',
    å…ƒå©´: `background: linear-gradient(90deg, #DA70D6, #BA55D3, #9932CC, #BA55D3, #DA70D6); ${animatedStyle}`,
    åŒ–ç¥: `background: linear-gradient(90deg, #DC143C, #FF4500, #B22222, #FF4500, #DC143C); ${animatedStyle}`,
    åˆä½“: `background: linear-gradient(90deg, #C71585, #FF1493, #DB7093, #FF1493, #C71585); ${animatedStyle}`,
    é£å‡: `background: linear-gradient(90deg, #FF416C, #FF4B2B, #FF6B6B, #FF4B2B, #FF416C); ${animatedStyle}`,
    ç¥æ¡¥: `background: linear-gradient(90deg, #cccccc, #ffffff, #bbbbbb, #ffffff, #cccccc); ${animatedStyle}`
  };
  
  return (styles[tier] || 'color: #e0dcd1;') + 'font-style: italic;';
}
```

## ç¬¬åäº”ç« ï¼šä¸–ç•Œä¹¦é›†æˆä¸è‡ªåŠ¨åŒ–ç³»ç»Ÿ

### 15.1 ä¸–ç•Œä¹¦è‡ªåŠ¨ç®¡ç†

#### 15.1.1 åŠ¨æ€æ¡ç›®åˆ›å»ºä¸ç®¡ç†
```javascript
// ä¸–ç•Œä¹¦æ¡ç›®è‡ªåŠ¨åˆ›å»ºæœºåˆ¶
async writeToLorebook(baseEntryKey, contentToWrite, silent = false) {
  const index = this.unifiedIndex;
  const finalEntryKey = index > 1 ? `${baseEntryKey}(${index})` : baseEntryKey;
  const bookName = '1å½’å¢Ÿ';
  
  try {
    const allEntries = await TavernHelper.getLorebookEntries(bookName);
    let targetEntry = allEntries.find(entry => entry.comment === finalEntryKey);
    
    if (!targetEntry) {
      // ä»åŸºç¡€æ¨¡æ¿åˆ›å»ºæ–°æ¡ç›®
      const baseEntryTemplate = allEntries.find(entry => entry.comment === baseEntryKey);
      const newEntryData = {
        comment: finalEntryKey,
        content: contentToWrite,
        keys: baseEntryTemplate ? [...baseEntryTemplate.keys, finalEntryKey] : [finalEntryKey],
        enabled: false,
        selective: baseEntryTemplate?.selective,
        constant: baseEntryTemplate?.constant,
        position: baseEntryTemplate?.position,
        case_sensitive: baseEntryTemplate?.case_sensitive
      };
      
      await TavernHelper.createLorebookEntries(bookName, [newEntryData]);
      if (!silent) this.showTemporaryMessage(`å·²æˆåŠŸåˆ›å»ºå¹¶å†™å…¥åˆ°"${finalEntryKey}"ã€‚`);
    } else {
      // è¿½åŠ åˆ°ç°æœ‰æ¡ç›®
      const existingContent = targetEntry.content || '';
      if (!existingContent.includes(contentToWrite)) {
        const updatedContent = existingContent + (existingContent ? '\n\n' : '') + contentToWrite;
        await TavernHelper.setLorebookEntries(bookName, [{ uid: targetEntry.uid, content: updatedContent }]);
        if (!silent) this.showTemporaryMessage(`å·²æˆåŠŸè¿½åŠ å†…å®¹åˆ°"${finalEntryKey}"ã€‚`);
      }
    }
  } catch (error) {
    console.error(`å†™å…¥ä¸–ç•Œä¹¦ "${finalEntryKey}" æ—¶å‡ºé”™:`, error);
    if (!silent) this.showTemporaryMessage(`å†™å…¥å¤±è´¥: ${error.message}`);
  }
}
```

#### 15.1.2 è‡ªåŠ¨å¼€å…³ä¸–ç•Œä¹¦è½®è¯¢
```javascript
// ä¸–ç•Œä¹¦æ¡ç›®è‡ªåŠ¨å¯ç”¨/ç¦ç”¨
async updateAutoToggledEntries(andDisableAll = false) {
  const bookName = '1å½’å¢Ÿ';
  const index = this.unifiedIndex;
  const journeyKey = index > 1 ? `æœ¬ä¸–å†ç¨‹(${index})` : 'æœ¬ä¸–å†ç¨‹';
  const pastLivesKey = index > 1 ? `å¾€ä¸–æ¶Ÿæ¼ª(${index})` : 'å¾€ä¸–æ¶Ÿæ¼ª';
  
  try {
    let allEntries = await TavernHelper.getLorebookEntries(bookName);
    const entriesToCreate = [];
    
    // æ£€æŸ¥å¹¶åˆ›å»ºç¼ºå¤±çš„æ¡ç›®
    const targetJourneyEntry = allEntries.find(e => e.comment === journeyKey);
    if (!targetJourneyEntry) {
      const baseTemplate = allEntries.find(e => e.comment === 'æœ¬ä¸–å†ç¨‹');
      if (baseTemplate) {
        const newJourneyEntry = { ...baseTemplate };
        delete newJourneyEntry.uid;
        newJourneyEntry.comment = journeyKey;
        newJourneyEntry.content = '';
        newJourneyEntry.keys = [...(baseTemplate.keys || []), journeyKey];
        newJourneyEntry.enabled = true;
        entriesToCreate.push(newJourneyEntry);
      }
    }
    
    // æ‰¹é‡åˆ›å»ºå’Œæ›´æ–°
    if (entriesToCreate.length > 0) {
      await TavernHelper.createLorebookEntries(bookName, entriesToCreate);
      allEntries = await TavernHelper.getLorebookEntries(bookName);
    }
    
    // æ›´æ–°å¯ç”¨çŠ¶æ€
    const entriesToUpdate = [];
    for (const entry of allEntries) {
      const isJourneyEntry = entry.comment.startsWith('æœ¬ä¸–å†ç¨‹');
      const isPastLivesEntry = entry.comment.startsWith('å¾€ä¸–æ¶Ÿæ¼ª');
      
      if (isJourneyEntry || isPastLivesEntry) {
        const isTarget = entry.comment === journeyKey || entry.comment === pastLivesKey;
        const shouldBeEnabled = isTarget && !andDisableAll;
        
        if (entry.enabled !== shouldBeEnabled) {
          entriesToUpdate.push({ uid: entry.uid, enabled: shouldBeEnabled });
        }
      }
    }
    
    if (entriesToUpdate.length > 0) {
      await TavernHelper.setLorebookEntries(bookName, entriesToUpdate);
    }
  } catch (error) {
    console.error('[å½’å¢Ÿè‡ªåŠ¨å¼€å…³] æ›´æ–°ä¸–ç•Œä¹¦æ¡ç›®çŠ¶æ€æ—¶å‡ºé”™:', error);
  }
}
```

### 15.2 å†…å®¹æå–ä¸è§£æ

#### 15.2.1 AIå›å¤æ ‡ç­¾æå–
```javascript
// å¥å£®çš„æ ‡ç­¾å†…å®¹æå–
_extractLastTagContent(tagName, text, ignoreCase = false) {
  if (!text || typeof text !== 'string') return null;
  
  const endTag = `</${tagName}>`;
  let searchPool = text;
  let endTagPattern = endTag;
  
  if (ignoreCase) {
    searchPool = text.toLowerCase();
    endTagPattern = endTag.toLowerCase();
  }
  
  const lastEndIndex = searchPool.lastIndexOf(endTagPattern);
  if (lastEndIndex !== -1) {
    const startTag = `<${tagName}>`;
    let startTagPattern = startTag;
    if (ignoreCase) startTagPattern = startTag.toLowerCase();
    
    const lastStartIndex = searchPool.lastIndexOf(startTagPattern, lastEndIndex);
    if (lastStartIndex !== -1) {
      const startIndex = lastStartIndex + startTag.length;
      return text.substring(startIndex, lastEndIndex).trim();
    }
  }
  return null;
}
```

#### 15.2.2 æ˜¾ç¤ºæ–‡æœ¬å‡€åŒ–
```javascript
// è·å–ç”¨äºæ˜¾ç¤ºçš„å‡€åŒ–æ–‡æœ¬
_getDisplayText(aiResponse) {
  try {
    if (!aiResponse || typeof aiResponse !== 'string') return '';
    
    // ä¼˜å…ˆæå– <gametxt> çš„å†…å®¹
    const gameText = this._extractLastTagContent('gametxt', aiResponse);
    if (gameText !== null) return gameText;
    
    // å¤‡ç”¨æ–¹æ¡ˆï¼šç§»é™¤æ‰€æœ‰å·²çŸ¥çš„éæ˜¾ç¤ºæ ‡ç­¾
    let cleanedText = aiResponse;
    const tagsToRemove = ['æœ¬ä¸–å†ç¨‹', 'å¾€ä¸–æ¶Ÿæ¼ª', 'UpdateVariable', 'è§’è‰²æå–', 'thinking'];
    
    tagsToRemove.forEach(tag => {
      // ç§»é™¤ <tag>...</tag> ç»“æ„
      const regexWithContent = new RegExp(`<${tag}>[\\s\\S]*?<\\/${tag}>`, 'gi');
      cleanedText = cleanedText.replace(regexWithContent, '');
      // ç§»é™¤è‡ªé—­åˆçš„ <tag/> ç»“æ„
      const regexSelfClosing = new RegExp(`<${tag}\\s*\\/>`, 'gi');
      cleanedText = cleanedText.replace(regexSelfClosing, '');
    });
    
    return cleanedText.trim();
  } catch (e) {
    console.error("è§£ææ˜¾ç¤ºæ–‡æœ¬æ—¶å‡ºé”™:", e);
    return "[æ‘˜è¦è§£æå¤±è´¥]";
  }
}
```

## ç¬¬åå…­ç« ï¼šå­˜æ¡£ç³»ç»Ÿä¸æ•°æ®æŒä¹…åŒ–

### 16.1 å¤šå­˜æ¡£ç®¡ç†æ¶æ„

#### 16.1.1 å­˜æ¡£æ•°æ®ç»“æ„è®¾è®¡
```javascript
// å­˜æ¡£æ•°æ®æ ¼å¼è§„èŒƒ
const saveDataPayload = {
  timestamp: new Date().toISOString(),
  save_name: saveName, // ç”¨æˆ·è‡ªå®šä¹‰å­˜æ¡£åç§°
  message_content: currentMessageContent, // AIå›å¤æ–‡æœ¬
  lorebook_entries: {
    journey_entry_name: `${saveName}-æœ¬ä¸–å†ç¨‹`,
    past_lives_entry_name: `${saveName}-å¾€ä¸–æ¶Ÿæ¼ª`
  },
  mvu_data: {
    stat_data: currentMvuData.stat_data,
    schema: currentMvuData.schema,
    initialized_lorebooks: currentMvuData.initialized_lorebooks,
    display_data: currentMvuData.display_data,
    delta_data: currentMvuData.delta_data
  }
};
```

#### 16.1.2 å­˜æ¡£æ§½ä½UIæ¸²æŸ“
```javascript
// å­˜æ¡£æ§½ä½çŠ¶æ€æ¸²æŸ“
renderSaveSlot(slotId, saveData) {
  const slotNumber = slotId.split('_')[1];
  
  if (!saveData) {
    return `
      <div class="save-slot" data-slot-id="${slotId}">
        <div class="save-slot-info">
          <div class="slot-name">å­˜æ¡£ ${slotNumber}</div>
          <div class="slot-time" style="font-style: italic; color: #8b7355;">ç©ºå­˜æ¡£ä½</div>
        </div>
        <div class="save-slot-actions">
          <button class="interaction-btn btn-save-slot">å­˜æ¡£</button>
          <button class="interaction-btn btn-load-slot" disabled>è¯»æ¡£</button>
          <button class="interaction-btn btn-delete-slot" disabled>åˆ é™¤</button>
        </div>
      </div>
    `;
  }
  
  // æ™ºèƒ½è§£æå­˜æ¡£æ•°æ®ç»“æ„
  let statDataForRender = null;
  if (saveData.mvu_data?.stat_data) {
    statDataForRender = saveData.mvu_data.stat_data;
  } else if (saveData.mvu_data?.['å½“å‰å¢ƒç•Œ']) {
    statDataForRender = saveData.mvu_data;
  }
  
  if (statDataForRender) {
    const date = new Date(saveData.timestamp).toLocaleString('zh-CN');
    const jingjie = this.SafeGetValue(statDataForRender, 'å½“å‰å¢ƒç•Œ.0', 'æœªçŸ¥å¢ƒç•Œ');
    const jinian = this.SafeGetValue(statDataForRender, 'å½“å‰æ—¶é—´çºªå¹´.0', 'æœªçŸ¥çºªå¹´');
    const summary = this._getDisplayText(saveData.message_content);
    const saveName = saveData.save_name || `å­˜æ¡£ ${slotNumber}`;
    
    return `
      <div class="save-slot" data-slot-id="${slotId}">
        <div class="save-slot-info">
          <div class="slot-name">${saveName}</div>
          <div class="slot-time">${date} - ${jingjie} - ${jinian}</div>
          <div class="slot-summary">${summary ? summary.substring(0, 40) + '...' : 'æ— æ­£æ–‡è®°å½•'}</div>
        </div>
        <div class="save-slot-actions">
          <button class="interaction-btn btn-save-slot">å­˜æ¡£</button>
          <button class="interaction-btn btn-load-slot">è¯»æ¡£</button>
          <button class="interaction-btn btn-delete-slot">åˆ é™¤</button>
        </div>
      </div>
    `;
  }
}
```

### 16.2 ä¸–ç•Œä¹¦æ¡ç›®å¤‡ä»½ä¸æ¢å¤

#### 16.2.1 å­˜æ¡£æ—¶åˆ›å»ºç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®
```javascript
// å­˜æ¡£æ—¶çš„ä¸–ç•Œä¹¦å¤‡ä»½æœºåˆ¶
async createLorebookBackup(saveName, index) {
  const bookName = '1å½’å¢Ÿ';
  const journeyKey = index > 1 ? `æœ¬ä¸–å†ç¨‹(${index})` : 'æœ¬ä¸–å†ç¨‹';
  const pastLivesKey = index > 1 ? `å¾€ä¸–æ¶Ÿæ¼ª(${index})` : 'å¾€ä¸–æ¶Ÿæ¼ª';
  
  const saveJourneyEntryName = `${saveName}-æœ¬ä¸–å†ç¨‹`;
  const savePastLivesEntryName = `${saveName}-å¾€ä¸–æ¶Ÿæ¼ª`;
  
  try {
    const allEntries = await TavernHelper.getLorebookEntries(bookName);
    const journeyEntry = allEntries.find(entry => entry.comment === journeyKey);
    const pastLivesEntry = allEntries.find(entry => entry.comment === pastLivesKey);
    
    const entriesToCreate = [];
    
    if (journeyEntry?.content) {
      entriesToCreate.push({
        comment: saveJourneyEntryName,
        content: journeyEntry.content,
        keys: [saveJourneyEntryName],
        enabled: false,
        position: 'before_character_definition',
        order: 20
      });
    }
    
    if (pastLivesEntry?.content) {
      entriesToCreate.push({
        comment: savePastLivesEntryName,
        content: pastLivesEntry.content,
        keys: [savePastLivesEntryName],
        enabled: false,
        position: 'before_character_definition',
        order: 19
      });
    }
    
    if (entriesToCreate.length > 0) {
      await TavernHelper.createLorebookEntries(bookName, entriesToCreate);
      console.log(`[å½’å¢Ÿå­˜æ¡£] å·²åˆ›å»º ${entriesToCreate.length} ä¸ªç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®`);
    }
    
    return {
      journey_entry_name: saveJourneyEntryName,
      past_lives_entry_name: savePastLivesEntryName
    };
  } catch (e) {
    console.error("åˆ›å»ºç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®æ—¶å‡ºé”™:", e);
    return null;
  }
}
```

#### 16.2.2 è¯»æ¡£æ—¶æ¢å¤ä¸–ç•Œä¹¦å†…å®¹
```javascript
// è¯»æ¡£æ—¶çš„ä¸–ç•Œä¹¦æ¢å¤æœºåˆ¶
async restoreLorebookFromSave(saveData) {
  if (!saveData.lorebook_entries) return;
  
  const entries = saveData.lorebook_entries;
  const bookName = '1å½’å¢Ÿ';
  const currentIndex = this.unifiedIndex;
  const currentJourneyKey = currentIndex > 1 ? `æœ¬ä¸–å†ç¨‹(${currentIndex})` : 'æœ¬ä¸–å†ç¨‹';
  const currentPastLivesKey = currentIndex > 1 ? `å¾€ä¸–æ¶Ÿæ¼ª(${currentIndex})` : 'å¾€ä¸–æ¶Ÿæ¼ª';
  
  try {
    const allEntries = await TavernHelper.getLorebookEntries(bookName);
    
    // æŸ¥æ‰¾å­˜æ¡£çš„ç‹¬ç«‹ä¸–ç•Œä¹¦æ¡ç›®
    const saveJourneyEntry = allEntries.find(entry => entry.comment === entries.journey_entry_name);
    const savePastLivesEntry = allEntries.find(entry => entry.comment === entries.past_lives_entry_name);
    
    // æŸ¥æ‰¾å½“å‰åºå·çš„ä¸–ç•Œä¹¦æ¡ç›®
    const currentJourneyEntry = allEntries.find(entry => entry.comment === currentJourneyKey);
    const currentPastLivesEntry = allEntries.find(entry => entry.comment === currentPastLivesKey);
    
    const entriesToUpdate = [];
    
    // è¦†å†™æœ¬ä¸–å†ç¨‹
    if (saveJourneyEntry?.content) {
      if (currentJourneyEntry) {
        entriesToUpdate.push({
          uid: currentJourneyEntry.uid,
          content: saveJourneyEntry.content
        });
      } else {
        await TavernHelper.createLorebookEntries(bookName, [{
          comment: currentJourneyKey,
          content: saveJourneyEntry.content,
          keys: [currentJourneyKey],
          enabled: true,
          position: 'before_character_definition',
          order: 20
        }]);
      }
    }
    
    // è¦†å†™å¾€ä¸–æ¶Ÿæ¼ª
    if (savePastLivesEntry?.content) {
      if (currentPastLivesEntry) {
        entriesToUpdate.push({
          uid: currentPastLivesEntry.uid,
          content: savePastLivesEntry.content
        });
      } else {
        await TavernHelper.createLorebookEntries(bookName, [{
          comment: currentPastLivesKey,
          content: savePastLivesEntry.content,
          keys: [currentPastLivesKey],
          enabled: true,
          position: 'before_character_definition',
          order: 19
        }]);
      }
    }
    
    // æ‰¹é‡æ›´æ–°ç°æœ‰æ¡ç›®
    if (entriesToUpdate.length > 0) {
      await TavernHelper.setLorebookEntries(bookName, entriesToUpdate);
    }
    
    console.log(`[å½’å¢Ÿè¯»æ¡£] å·²å°†å­˜æ¡£çš„ä¸–ç•Œä¹¦æ•°æ®è¦†å†™åˆ°å½“å‰åºå· ${currentIndex}`);
  } catch (e) {
    console.error("æ¢å¤ä¸–ç•Œä¹¦æ•°æ®æ—¶å‡ºé”™:", e);
    this.showTemporaryMessage("è­¦å‘Šï¼šæ¢å¤ä¸–ç•Œä¹¦æ•°æ®å¤±è´¥ï¼Œä½†ä¸»æ•°æ®å·²æ¢å¤ã€‚");
  }
}
```

## ç¬¬åä¸ƒç« ï¼šæ€§èƒ½ä¼˜åŒ–ä¸æœ€ä½³å®è·µ

### 17.1 æ¸²æŸ“æ€§èƒ½ä¼˜åŒ–

#### 17.1.1 é˜²æŠ–ä¸èŠ‚æµæœºåˆ¶
```javascript
// é˜²æŠ–æ¸²æŸ“ï¼Œé¿å…é¢‘ç¹æ›´æ–°
const debouncedRender = _.debounce((data) => {
  GuixuManager.renderUI(data);
}, 100);

// èŠ‚æµçš„å±æ€§æ›´æ–°
const throttledAttributeUpdate = _.throttle(() => {
  GuixuManager.updateDisplayedAttributes();
}, 200);

// è™šæ‹ŸDOMå·®å¼‚æ›´æ–°
function updateElementIfChanged(element, newContent) {
  if (element.innerHTML !== newContent) {
    element.innerHTML = newContent;
    return true; // è¡¨ç¤ºå‘ç”Ÿäº†æ›´æ–°
  }
  return false; // è¡¨ç¤ºæ— éœ€æ›´æ–°
}
```

#### 17.1.2 äº‹ä»¶ç›‘å¬å™¨ä¼˜åŒ–
```javascript
// äº‹ä»¶å§”æ‰˜å‡å°‘å†…å­˜å ç”¨
bindEventDelegation() {
  // ä½¿ç”¨å•ä¸ªç›‘å¬å™¨å¤„ç†æ‰€æœ‰èƒŒåŒ…äº¤äº’
  const inventoryModalBody = document.querySelector('#inventory-modal .modal-body');
  inventoryModalBody.addEventListener('click', this.handleInventoryClick.bind(this));
  
  // ä½¿ç”¨å•ä¸ªç›‘å¬å™¨å¤„ç†æ‰€æœ‰è£…å¤‡æ§½äº¤äº’
  const characterPanel = document.querySelector('.character-panel');
  characterPanel.addEventListener('click', this.handleEquipmentClick.bind(this));
  characterPanel.addEventListener('mouseover', this.handleEquipmentHover.bind(this));
  characterPanel.addEventListener('mouseout', this.handleEquipmentLeave.bind(this));
}

// ç»Ÿä¸€çš„äº‹ä»¶å¤„ç†å™¨
handleInventoryClick(e) {
  const target = e.target;
  const itemElement = target.closest('.inventory-item');
  if (!itemElement) return;
  
  const itemData = JSON.parse(itemElement.dataset.itemDetails || '{}');
  const category = itemElement.dataset.category;
  
  if (target.classList.contains('item-equip-btn')) {
    this.equipItem(itemData, category, target);
  } else if (target.classList.contains('item-use-btn')) {
    this.useItem(itemData, target);
  } else if (target.classList.contains('item-unequip-btn')) {
    const slotId = target.dataset.slotId;
    this.unequipItem(slotId, document.getElementById(slotId), true, true);
  }
}
```

### 17.2 å†…å­˜ç®¡ç†ä¸ç¼“å­˜ç­–ç•¥

#### 17.2.1 æ™ºèƒ½ç¼“å­˜æœºåˆ¶
```javascript
// å¤šå±‚ç¼“å­˜ç­–ç•¥
const CacheManager = {
  // L1ç¼“å­˜ï¼šå†…å­˜ä¸­çš„çƒ­æ•°æ®
  memoryCache: new Map(),
  
  // L2ç¼“å­˜ï¼šlocalStorageä¸­çš„æŒä¹…æ•°æ®
  persistentCache: {
    get(key) {
      try {
        const data = localStorage.getItem(`guixu_cache_${key}`);
        return data ? JSON.parse(data) : null;
      } catch (e) {
        return null;
      }
    },
    
    set(key, value, ttl = 3600000) { // é»˜è®¤1å°æ—¶TTL
      try {
        const cacheData = {
          value: value,
          timestamp: Date.now(),
          ttl: ttl
        };
        localStorage.setItem(`guixu_cache_${key}`, JSON.stringify(cacheData));
      } catch (e) {
        console.warn('ç¼“å­˜å†™å…¥å¤±è´¥:', e);
      }
    },
    
    isValid(key) {
      const data = this.get(key);
      if (!data) return false;
      return (Date.now() - data.timestamp) < data.ttl;
    }
  },
  
  // æ™ºèƒ½è·å–ï¼šä¼˜å…ˆå†…å­˜ï¼Œå…¶æ¬¡æŒä¹…ç¼“å­˜ï¼Œæœ€åé‡æ–°è®¡ç®—
  async smartGet(key, computeFn) {
    // L1ç¼“å­˜å‘½ä¸­
    if (this.memoryCache.has(key)) {
      return this.memoryCache.get(key);
    }
    
    // L2ç¼“å­˜å‘½ä¸­ä¸”æœ‰æ•ˆ
    if (this.persistentCache.isValid(key)) {
      const cachedData = this.persistentCache.get(key);
      this.memoryCache.set(key, cachedData.value);
      return cachedData.value;
    }
    
    // ç¼“å­˜æœªå‘½ä¸­ï¼Œé‡æ–°è®¡ç®—
    const freshData = await computeFn();
    this.memoryCache.set(key, freshData);
    this.persistentCache.set(key, freshData);
    return freshData;
  }
};
```

#### 17.2.2 å†…å­˜æ³„æ¼é˜²æŠ¤
```javascript
// å®šæœŸæ¸…ç†æœºåˆ¶
const MemoryManager = {
  cleanupInterval: null,
  
  startCleanup() {
    this.cleanupInterval = setInterval(() => {
      this.performCleanup();
    }, 300000); // æ¯5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡
  },
  
  performCleanup() {
    // æ¸…ç†è¿‡æœŸçš„å†…å­˜ç¼“å­˜
    const now = Date.now();
    for (const [key, data] of CacheManager.memoryCache.entries()) {
      if (data.timestamp && (now - data.timestamp) > 1800000) { // 30åˆ†é’Ÿè¿‡æœŸ
        CacheManager.memoryCache.delete(key);
      }
    }
    
    // æ¸…ç†DOMä¸­çš„å­¤ç«‹äº‹ä»¶ç›‘å¬å™¨
    this.cleanupOrphanedListeners();
    
    // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (window.gc) {
      window.gc();
    }
  },
  
  cleanupOrphanedListeners() {
    // ç§»é™¤å·²åˆ é™¤å…ƒç´ çš„äº‹ä»¶ç›‘å¬å™¨
    const allElements = document.querySelectorAll('[data-cleanup-listeners]');
    allElements.forEach(element => {
      if (!element.isConnected) {
        element.removeEventListener('click', element._clickHandler);
        element.removeEventListener('mouseover', element._hoverHandler);
      }
    });
  }
};
```

### 17.3 é”™è¯¯å¤„ç†ä¸å®¹é”™æœºåˆ¶

#### 17.3.1 åˆ†å±‚é”™è¯¯å¤„ç†
```javascript
// å…¨å±€é”™è¯¯å¤„ç†å™¨
const ErrorHandler = {
  // é”™è¯¯çº§åˆ«å®šä¹‰
  ERROR_LEVELS: {
    CRITICAL: 'critical',    // ç³»ç»Ÿå´©æºƒçº§åˆ«
    HIGH: 'high',           // åŠŸèƒ½ä¸å¯ç”¨
    MEDIUM: 'medium',       // åŠŸèƒ½å—é™
    LOW: 'low'             // è½»å¾®å½±å“
  },
  
  // é”™è¯¯å¤„ç†ç­–ç•¥
  handleError(error, level = this.ERROR_LEVELS.MEDIUM, context = '') {
    console.error(`[å½’å¢Ÿé”™è¯¯-${level}] ${context}:`, error);
    
    switch (level) {
      case this.ERROR_LEVELS.CRITICAL:
        this.handleCriticalError(error, context);
        break;
      case this.ERROR_LEVELS.HIGH:
        this.handleHighError(error, context);
        break;
      case this.ERROR_LEVELS.MEDIUM:
        this.handleMediumError(error, context);
        break;
      case this.ERROR_LEVELS.LOW:
        this.handleLowError(error, context);
        break;
    }
  },
  
  handleCriticalError(error, context) {
    // å°è¯•æ•°æ®æ¢å¤
    GuixuManager.recoverFromCorruption();
    
    // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
    GuixuManager.showCustomConfirm(
      `ç³»ç»Ÿé‡åˆ°ä¸¥é‡é”™è¯¯ï¼š${error.message}\næ˜¯å¦å°è¯•é‡æ–°åŠ è½½ï¼Ÿ`,
      () => window.location.reload()
    );
  },
  
  handleHighError(error, context) {
    // ç¦ç”¨ç›¸å…³åŠŸèƒ½
    this.disableAffectedFeatures(context);
    
    // æç¤ºç”¨æˆ·
    GuixuManager.showTemporaryMessage(`åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨ï¼š${error.message}`, 5000);
  },
  
  handleMediumError(error, context) {
    // å°è¯•å¤‡ç”¨æ–¹æ¡ˆ
    this.tryFallbackSolution(error, context);
    
    // è®°å½•é”™è¯¯ä½†ä¸æ‰“æ–­ç”¨æˆ·
    GuixuManager.showTemporaryMessage(`æ“ä½œé‡åˆ°é—®é¢˜ï¼Œå·²è‡ªåŠ¨å¤„ç†`, 3000);
  },
  
  handleLowError(error, context) {
    // é™é»˜å¤„ç†ï¼Œä»…è®°å½•æ—¥å¿—
    console.warn(`[å½’å¢Ÿè­¦å‘Š] ${context}: ${error.message}`);
  }
};
```

#### 17.3.2 æ•°æ®ä¸€è‡´æ€§éªŒè¯
```javascript
// æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
const DataValidator = {
  // éªŒè¯MVUæ•°æ®ç»“æ„
  validateMVUData(data) {
    const requiredFields = [
      'å½“å‰å¢ƒç•Œ', 'æ³•åŠ›', 'ç¥æµ·', 'é“å¿ƒ', 'ç©ºé€Ÿ', 'æ°”è¿',
      'å½“å‰æ³•åŠ›', 'å½“å‰ç¥æµ·', 'å½“å‰é“å¿ƒ', 'å½“å‰ç©ºé€Ÿ'
    ];
    
    const missingFields = requiredFields.filter(field => {
      const value = GuixuManager.SafeGetValue(data, field);
      return value === 'N/A' || value === undefined || value === null;
    });
    
    if (missingFields.length > 0) {
      throw new Error(`MVUæ•°æ®ç¼ºå°‘å¿…è¦å­—æ®µ: ${missingFields.join(', ')}`);
    }
    
    return true;
  },
  
  // éªŒè¯è£…å¤‡æ•°æ®ä¸€è‡´æ€§
  validateEquipmentConsistency() {
    const mvuEquipment = this.extractMVUEquipment();
    const frontendEquipment = GuixuManager.equippedItems;
    
    const inconsistencies = [];
    
    for (const [slotKey, frontendItem] of Object.entries(frontendEquipment)) {
      const mvuItem = mvuEquipment[slotKey];
      
      if (frontendItem && !mvuItem) {
        inconsistencies.push(`å‰ç«¯æ˜¾ç¤ºè£…å¤‡ ${frontendItem.name}ï¼Œä½†MVUä¸­æœªæ‰¾åˆ°`);
      } else if (!frontendItem && mvuItem) {
        inconsistencies.push(`MVUä¸­æœ‰è£…å¤‡ ${mvuItem.name}ï¼Œä½†å‰ç«¯æœªæ˜¾ç¤º`);
      } else if (frontendItem && mvuItem && frontendItem.id !== mvuItem.id) {
        inconsistencies.push(`è£…å¤‡æ§½ ${slotKey} æ•°æ®ä¸ä¸€è‡´`);
      }
    }
    
    if (inconsistencies.length > 0) {
      console.warn('[æ•°æ®ä¸€è‡´æ€§] å‘ç°ä¸ä¸€è‡´:', inconsistencies);
      return false;
    }
    
    return true;
  },
  
  // è‡ªåŠ¨ä¿®å¤æ•°æ®ä¸ä¸€è‡´
  async autoFixInconsistencies() {
    try {
      // ä»¥MVUæ•°æ®ä¸ºå‡†è¿›è¡Œä¿®å¤
      const messages = await getChatMessages(getCurrentMessageId());
      const authoritativeData = messages[0].data;
      
      GuixuManager.currentMvuState = authoritativeData;
      GuixuManager.renderUI(authoritativeData.stat_data);
      GuixuManager.loadEquipmentFromMVU(authoritativeData.stat_data);
      
      console.log('[æ•°æ®ä¿®å¤] å·²ä»¥MVUæ•°æ®ä¸ºå‡†å®Œæˆä¿®å¤');
      return true;
    } catch (error) {
      console.error('[æ•°æ®ä¿®å¤] è‡ªåŠ¨ä¿®å¤å¤±è´¥:', error);
      return false;
    }
  }
};
```

## ç¬¬åå…«ç« ï¼šå¼€å‘è°ƒè¯•ä¸ç»´æŠ¤æŒ‡å—

### 18.1 è°ƒè¯•å·¥å…·ä¸æŠ€å·§

#### 18.1.1 è°ƒè¯•æ¨¡å¼é…ç½®
```javascript
// è°ƒè¯•é…ç½®ç®¡ç†
const DebugConfig = {
  enabled: false, // ç”Ÿäº§ç¯å¢ƒè®¾ä¸ºfalse
  logLevel: 'info', // 'debug', 'info', 'warn', 'error'
  modules: {
    mvu: true,        // MVUæ•°æ®ç›¸å…³æ—¥å¿—
    ui: true,         // UIæ¸²æŸ“ç›¸å…³æ—¥å¿—
    equipment: true,  // è£…å¤‡ç³»ç»Ÿæ—¥å¿—
    lorebook: true,   // ä¸–ç•Œä¹¦æ“ä½œæ—¥å¿—
    performance: false // æ€§èƒ½ç›‘æ§æ—¥å¿—
  },
  
  log(module, level, message, ...args) {
    if (!this.enabled || !this.modules[module]) return;
    
    const levels = ['debug', 'info', 'warn', 'error'];
    const currentLevelIndex = levels.indexOf(this.logLevel);
    const messageLevelIndex = levels.indexOf(level);
    
    if (messageLevelIndex >= currentLevelIndex) {
      const timestamp = new Date().toISOString();
      const prefix = `[å½’å¢Ÿ-${module.toUpperCase()}] ${timestamp}`;
      console[level](`${prefix} ${message}`, ...args);
    }
  },
  
  // ä¾¿æ·æ–¹æ³•
  debug(module, message, ...args) { this.log(module, 'debug', message, ...args); },
  info(module, message, ...args) { this.log(module, 'info', message, ...args); },
  warn(module, message, ...args) { this.log(module, 'warn', message, ...args); },
  error(module, message, ...args) { this.log(module, 'error', message, ...args); }
};

// ä½¿ç”¨ç¤ºä¾‹
DebugConfig.info('mvu', 'MVUçŠ¶æ€æ›´æ–°:', oldState, '=>', newState);
DebugConfig.debug('ui', 'è£…å¤‡æ§½ä½æ›´æ–°:', slotKey, item);
```

#### 18.1.2 æ€§èƒ½ç›‘æ§å·¥å…·
```javascript
// æ€§èƒ½ç›‘æ§å™¨
const PerformanceMonitor = {
  timers: new Map(),
  metrics: new Map(),
  
  // å¼€å§‹è®¡æ—¶
  startTimer(name) {
    this.timers.set(name, performance.now());
  },
  
  // ç»“æŸè®¡æ—¶å¹¶è®°å½•
  endTimer(name) {
    const startTime = this.timers.get(name);
    if (startTime) {
      const duration = performance.now() - startTime;
      this.recordMetric(name, duration);
      this.timers.delete(name);
      
      DebugConfig.debug('performance', `${name} è€—æ—¶: ${duration.toFixed(2)}ms`);
      return duration;
    }
    return null;
  },
  
  // è®°å½•æ€§èƒ½æŒ‡æ ‡
  recordMetric(name, value) {
    if (!this.metrics.has(name)) {
      this.metrics.set(name, []);
    }
    
    const values = this.metrics.get(name);
    values.push(value);
    
    // ä¿æŒæœ€è¿‘100æ¬¡è®°å½•
    if (values.length > 100) {
      values.shift();
    }
  },
  
  // è·å–æ€§èƒ½ç»Ÿè®¡
  getStats(name) {
    const values = this.metrics.get(name);
    if (!values || values.length === 0) return null;
    
    const sorted = [...values].sort((a, b) => a - b);
    return {
      count: values.length,
      min: sorted[0],
      max: sorted[sorted.length - 1],
      avg: values.reduce((a, b) => a + b, 0) / values.length,
      median: sorted[Math.floor(sorted.length / 2)],
      p95: sorted[Math.floor(sorted.length * 0.95)]
    };
  },
  
  // æ€§èƒ½æŠ¥å‘Š
  generateReport() {
    const report = {};
    for (const [name] of this.metrics) {
      report[name] = this.getStats(name);
    }
    return report;
  }
};

// ä½¿ç”¨ç¤ºä¾‹
PerformanceMonitor.startTimer('renderUI');
GuixuManager.renderUI(data);
PerformanceMonitor.endTimer('renderUI');
```

### 18.2 å•å…ƒæµ‹è¯•ä¸é›†æˆæµ‹è¯•

#### 18.2.1 æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
```javascript
// æµ‹è¯•å·¥å…·é›†
const TestUtils = {
  // æ¨¡æ‹ŸMVUæ•°æ®
  createMockMVUData() {
    return {
      stat_data: {
        'å½“å‰å¢ƒç•Œ': ['ç»ƒæ°”ä¸€å±‚', 'æè¿°'],
        'æ³•åŠ›': [100, 'æè¿°'],
        'å½“å‰æ³•åŠ›': [100, 'æè¿°'],
        'ç¥æµ·': [50, 'æè¿°'],
        'å½“å‰ç¥æµ·': [50, 'æè¿°'],
        'é“å¿ƒ': [10, 'æè¿°'],
        'å½“å‰é“å¿ƒ': [10, 'æè¿°'],
        'ç©ºé€Ÿ': [5, 'æè¿°'],
        'å½“å‰ç©ºé€Ÿ': [5, 'æè¿°'],
        'æ°”è¿': [10, 'æè¿°']
      }
    };
  },
  
  // æ¨¡æ‹Ÿè£…å¤‡æ•°æ®
  createMockEquipment() {
    return {
      id: 'test_sword_001',
      name: 'æµ‹è¯•é’é’¢å‰‘',
      tier: 'ç­‘åŸº',
      attributes_bonus: { 'æ³•åŠ›': 20, 'ç©ºé€Ÿ': 5 },
      special_effects: ['é”‹åˆ©', 'è½»ç›ˆ']
    };
  },
  
  // æ–­è¨€å·¥å…·
  assert(condition, message) {
    if (!condition) {
      throw new Error(`æ–­è¨€å¤±è´¥: ${message}`);
    }
  },
  
  assertEqual(actual, expected, message) {
    if (actual !== expected) {
      throw new Error(`æ–­è¨€å¤±è´¥: ${message}. æœŸæœ›: ${expected}, å®é™…: ${actual}`);
    }
  }
};

// æµ‹è¯•å¥—ä»¶
const TestSuite = {
  // æµ‹è¯•SafeGetValueå‡½æ•°
  testSafeGetValue() {
    const testData = {
      simple: 'value',
      array: ['arrayValue', 'description'],
      nested: { deep: { value: 'nestedValue' } }
    };
    
    TestUtils.assertEqual(
      GuixuManager.SafeGetValue(testData, 'simple'),
      'value',
      'SafeGetValueåº”è¯¥æ­£ç¡®è·å–ç®€å•å€¼'
    );
    
    TestUtils.assertEqual(
      GuixuManager.SafeGetValue(testData, 'array'),
      'arrayValue',
      'SafeGetValueåº”è¯¥æ­£ç¡®è·å–æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ '
    );
    
    TestUtils.assertEqual(
      GuixuManager.SafeGetValue(testData, 'nested.deep.value'),
      'nestedValue',
      'SafeGetValueåº”è¯¥æ­£ç¡®è·å–åµŒå¥—å€¼'
    );
    
    TestUtils.assertEqual(
      GuixuManager.SafeGetValue(testData, 'nonexistent', 'default'),
      'default',
      'SafeGetValueåº”è¯¥è¿”å›é»˜è®¤å€¼'
    );
  },
  
  // æµ‹è¯•è£…å¤‡ç³»ç»Ÿ
  testEquipmentSystem() {
    const mockEquipment = TestUtils.createMockEquipment();
    
    // æµ‹è¯•è£…å¤‡
    GuixuManager.equipItem(mockEquipment, 'æ­¦å™¨', null);
    TestUtils.assert(
      GuixuManager.equippedItems.wuqi === mockEquipment,
      'è£…å¤‡åº”è¯¥è¢«æ­£ç¡®å­˜å‚¨'
    );
    
    // æµ‹è¯•å¸è½½
    GuixuManager.unequipItem('equip-wuqi', document.getElementById('equip-wuqi'), false);
    TestUtils.assert(
      GuixuManager.equippedItems.wuqi === null,
      'è£…å¤‡åº”è¯¥è¢«æ­£ç¡®å¸è½½'
    );
  },
  
  // è¿è¡Œæ‰€æœ‰æµ‹è¯•
  runAll() {
    const tests = [
      'testSafeGetValue',
      'testEquipmentSystem'
    ];
    
    let passed = 0;
    let failed = 0;
    
    tests.forEach(testName => {
      try {
        this[testName]();
        console.log(`âœ… ${testName} é€šè¿‡`);
        passed++;
      } catch (error) {
        console.error(`âŒ ${testName} å¤±è´¥:`, error.message);
        failed++;
      }
    });
    
    console.log(`æµ‹è¯•å®Œæˆ: ${passed} é€šè¿‡, ${failed} å¤±è´¥`);
    return { passed, failed };
  }
};
```

### 18.3 ç»´æŠ¤ä¸æ›´æ–°æŒ‡å—

#### 18.3.1 ç‰ˆæœ¬ç®¡ç†ç­–ç•¥
```javascript
// ç‰ˆæœ¬ä¿¡æ¯ç®¡ç†
const VersionManager = {
  current: '2.0.0',
  
  // ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
  checkCompatibility(dataVersion) {
    const [major, minor, patch] = this.current.split('.').map(Number);
    const [dataMajor, dataMinor, dataPatch] = dataVersion.split('.').map(Number);
    
    // ä¸»ç‰ˆæœ¬ä¸å…¼å®¹
    if (major !== dataMajor) {
      return {
        compatible: false,
        reason: 'ä¸»ç‰ˆæœ¬ä¸å…¼å®¹ï¼Œéœ€è¦æ•°æ®è¿ç§»'
      };
    }
    
    // æ¬¡ç‰ˆæœ¬å‘åå…¼å®¹
    if (minor < dataMinor) {
      return {
        compatible: false,
        reason: 'æ•°æ®ç‰ˆæœ¬è¿‡æ–°ï¼Œè¯·æ›´æ–°ç³»ç»Ÿ'
      };
    }
    
    return { compatible: true };
  },
  
  // æ•°æ®è¿ç§»
  async migrateData(oldData, fromVersion, toVersion) {
    const migrations = this.getMigrationPath(fromVersion, toVersion);
    
    let currentData = _.cloneDeep(oldData);
    for (const migration of migrations) {
      currentData = await migration(currentData);
    }
    
    return currentData;
  },
  
  // è·å–è¿ç§»è·¯å¾„
  getMigrationPath(from, to) {
    const migrations = [];
    
    // ç¤ºä¾‹ï¼šä»1.xåˆ°2.xçš„è¿ç§»
    if (from.startsWith('1.') && to.startsWith('2.')) {
      migrations.push(this.migrate_1_to_2);
    }
    
    return migrations;
  },
  
  // å…·ä½“è¿ç§»å‡½æ•°
  async migrate_1_to_2(data) {
    // ç¤ºä¾‹è¿ç§»ï¼šé‡å‘½åå­—æ®µ
    if (data.stat_data) {
      // å°†æ—§çš„å­—æ®µåè¿ç§»åˆ°æ–°çš„å­—æ®µå
      if (data.stat_data['æ—§å­—æ®µå']) {
        data.stat_data['æ–°å­—æ®µå'] = data.stat_data['æ—§å­—æ®µå'];
        delete data.stat_data['æ—§å­—æ®µå'];
      }
    }
    
    return data;
  }
};
```

#### 18.3.2 é…ç½®ç®¡ç†ç³»ç»Ÿ
```javascript
// é…ç½®ç®¡ç†å™¨
const ConfigManager = {
  defaultConfig: {
    ui: {
      animationSpeed: 'normal', // 'slow', 'normal', 'fast'
      theme: 'dark',            // 'dark', 'light'
      compactMode: false,       // ç´§å‡‘æ¨¡å¼
      showTooltips: true        // æ˜¾ç¤ºæ‚¬æµ®æç¤º
    },
    performance: {
      enableCache: true,        // å¯ç”¨ç¼“å­˜
      maxCacheSize: 100,        // æœ€å¤§ç¼“å­˜æ¡ç›®æ•°
      autoCleanup: true,        // è‡ªåŠ¨æ¸…ç†
      debugMode: false          // è°ƒè¯•æ¨¡å¼
    },
    features: {
      autoSave: true,           // è‡ªåŠ¨ä¿å­˜
      autoWriteLorebook: true,  // è‡ªåŠ¨å†™å…¥ä¸–ç•Œä¹¦
      mobileOptimization: true  // ç§»åŠ¨ç«¯ä¼˜åŒ–
    }
  },
  
  // è·å–é…ç½®
  get(path, defaultValue) {
    try {
      const userConfig = JSON.parse(localStorage.getItem('guixu_config') || '{}');
      const mergedConfig = _.merge({}, this.defaultConfig, userConfig);
      return _.get(mergedConfig, path, defaultValue);
    } catch (e) {
      return _.get(this.defaultConfig, path, defaultValue);
    }
  },
  
  // è®¾ç½®é…ç½®
  set(path, value) {
    try {
      const userConfig = JSON.parse(localStorage.getItem('guixu_config') || '{}');
      _.set(userConfig, path, value);
      localStorage.setItem('guixu_config', JSON.stringify(userConfig));
      
      // è§¦å‘é…ç½®å˜æ›´äº‹ä»¶
      this.onConfigChange(path, value);
    } catch (e) {
      console.error('ä¿å­˜é…ç½®å¤±è´¥:', e);
    }
  },
  
  // é…ç½®å˜æ›´å¤„ç†
  onConfigChange(path, value) {
    switch (path) {
      case 'ui.theme':
        this.applyTheme(value);
        break;
      case 'ui.animationSpeed':
        this.applyAnimationSpeed(value);
        break;
      case 'performance.debugMode':
        DebugConfig.enabled = value;
        break;
    }
  },
  
  // åº”ç”¨ä¸»é¢˜
  applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
  },
  
  // åº”ç”¨åŠ¨ç”»é€Ÿåº¦
  applyAnimationSpeed(speed) {
    const speedMap = { slow: 2, normal: 1, fast: 0.5 };
    const factor = speedMap[speed] || 1;
    document.documentElement.style.setProperty('--animation-speed-factor', factor);
  }
};
```

è¿™å¥—å®Œæ•´çš„è®°å¿†é“¶è¡Œç°åœ¨åŒ…å«äº†ï¼š

1. **å®Œæ•´çš„å‰ç«¯æ¶æ„æ–‡æ¡£** - ä»åŸºç¡€ç»„ä»¶åˆ°é«˜çº§äº¤äº’çš„å…¨é¢è¦†ç›–
2. **è¯¦ç»†çš„UIç»„ä»¶è¯´æ˜** - æ¯ä¸ªç»„ä»¶çš„å®ç°ç»†èŠ‚å’Œäº¤äº’é€»è¾‘
3. **æ•°æ®æµå’ŒçŠ¶æ€ç®¡ç†** - å®Œæ•´çš„æ•°æ®åŒæ­¥å’ŒçŠ¶æ€ç®¡ç†ç­–ç•¥
4. **é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶** - å¤šå±‚é”™è¯¯å¤„ç†å’Œæ•°æ®æ¢å¤æœºåˆ¶
5. **æ€§èƒ½ä¼˜åŒ–æŒ‡å—** - æ¸²æŸ“ä¼˜åŒ–ã€å†…å­˜ç®¡ç†å’Œç¼“å­˜ç­–ç•¥
6. **å¼€å‘è°ƒè¯•å·¥å…·** - è°ƒè¯•é…ç½®ã€æ€§èƒ½ç›‘æ§å’Œæµ‹è¯•å·¥å…·
7. **ç»´æŠ¤å’Œæ›´æ–°æŒ‡å—** - ç‰ˆæœ¬ç®¡ç†ã€æ•°æ®è¿ç§»å’Œé…ç½®ç®¡ç†

ä¸ºå½’å¢ŸPlusé¡¹ç›®æä¾›äº†å®Œæ•´çš„æŠ€æœ¯æ–‡æ¡£å’Œæœ€ä½³å®è·µæŒ‡å—ã€‚
