# 反派逆袭系统 - 跨域解决方案分析

## 当前问题
GitHub Pages 的 iframe 无法访问 SillyTavern 的 `TavernHelper` API，原因是浏览器的同源策略（CORS）。

## 三种部署方案对比

### 方案 A：本地安装（推荐 ✅）

**工作原理**：
- 将游戏文件放在 `SillyTavern/public/villain-game/`
- 使用 iframe 加载 `/villain-game/index.html`
- 因为同源（都是 `localhost:8000`），可以直接访问 `TavernHelper`

**优点**：
- ✅ 没有跨域限制，完全可以访问 TavernHelper API
- ✅ 加载速度快（本地文件）
- ✅ 完全离线运行
- ✅ 稳定可靠

**缺点**：
- ❌ 需要用户手动安装（复制文件）
- ❌ 不能通过角色卡分享（需要单独分发文件）

**实现状态**：✅ 已完成

---

### 方案 B：jQuery 远程加载

**工作原理**：
```html
<body>
<script>
$("body").load("https://ambroselbt28-gif.github.io/-/index.html");
</script>
</body>
```

**技术分析**：
1. jQuery 的 `load()` 使用 AJAX 获取远程 HTML
2. 将 HTML 内容插入到当前页面的 `<body>` 中
3. 执行其中的 JavaScript 代码

**关键问题**：
- ❓ **仍然存在跨域问题**：AJAX 请求受到 CORS 限制
- ❓ **需要服务器配置 CORS 头部**：GitHub Pages 默认 **不允许** 跨域 AJAX 请求
- ❓ **即使加载成功，JavaScript 仍在同一上下文**：加载后的 JS 代码仍然无法访问 `parent.TavernHelper`

**测试结果预期**：
```
❌ CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

**优点**（理论上）：
- ✅ 可以通过角色卡分享
- ✅ 远程更新，无需用户重新下载

**缺点**：
- ❌ **不能解决跨域问题**（仍然无法访问 TavernHelper）
- ❌ 需要 CORS 配置（GitHub Pages 不支持）
- ❌ 依赖网络连接
- ❌ 加载速度较慢

**实现状态**：❌ 不可行

---

### 方案 C：Webpack 单文件打包 + 正则嵌入

**工作原理**：
1. 使用 Webpack 将所有代码（HTML + CSS + JS）打包成一个 HTML 文件
2. 在世界书的正则替换中嵌入完整的 HTML
3. 让正则替换将游戏界面注入到聊天界面中

**参考实现**：GoblinGame 的 `webpack.config.ts`
```typescript
plugins: [
  new HtmlWebpackPlugin({...}),
  new HtmlInlineScriptWebpackPlugin(),  // 内联所有 JS
  new HTMLInlineCSSWebpackPlugin(),      // 内联所有 CSS
  new webpack.optimize.LimitChunkCountPlugin({ maxChunks: 1 })
]
```

**关键问题**：
- ✅ 可以打包成单文件
- ❓ **仍然无法访问 TavernHelper**：即使在世界书中嵌入，代码仍运行在 iframe 外的上下文中
- ❓ **正则替换有大小限制**：单文件可能过大（参考：GoblinGame 打包后 2.9MB）

**优点**：
- ✅ 可以通过角色卡分享（如果文件不太大）
- ✅ 无需额外安装
- ✅ 无跨域问题（直接嵌入页面）

**缺点**：
- ❌ **仍然无法访问 TavernHelper API**
- ❌ 打包文件可能过大
- ❌ 需要复杂的构建配置
- ❌ 维护成本高

**实现状态**：⚠️ 技术可行，但不能解决核心问题

---

## 根本问题分析

### 为什么 GoblinGame 可以使用 jQuery 加载？

检查 GoblinGame 的代码后发现关键点：

**GoblinGame 的部署方式**：
- 不是通过 iframe 加载
- 直接在 SillyTavern 的页面上下文中运行
- 使用 TavernHelper 扩展提供的 API

**你的反派游戏的情况**：
- 通过 iframe 加载（`<iframe src="...">`）
- 运行在不同的源（GitHub Pages vs localhost）
- **iframe 的跨域限制无法绕过**

### 为什么归墟Plus 可以访问 TavernHelper？

归墟Plus 的部署方式（从参考文档分析）：
```
SillyTavern/public/归墟plus/index.html
访问路径: http://localhost:8000/归墟plus/index.html
```

- ✅ 同源（都是 `localhost:8000`）
- ✅ 可以直接访问 `TavernHelper`
- ✅ 没有跨域限制

---

## 结论

### 方案 A（本地安装）是唯一可行的解决方案

**原因**：
1. **跨域限制无法绕过**：浏览器的同源策略是安全机制，无法通过技术手段绕过
2. **jQuery 加载不能解决问题**：即使能加载 HTML，仍然无法访问 `TavernHelper` API
3. **本地安装才能同源**：只有部署在 SillyTavern 的 public 目录下，才能与主应用同源

### 对比表格

| 方案 | 访问 TavernHelper | 分享便利性 | 安装难度 | 推荐度 |
|------|------------------|-----------|---------|--------|
| **A. 本地安装** | ✅ 完全可用 | ⚠️ 需要分发文件 | ⚠️ 需要手动复制 | ⭐⭐⭐⭐⭐ |
| **B. jQuery 加载** | ❌ 无法访问 | ✅ 可嵌入角色卡 | ✅ 无需安装 | ⭐ |
| **C. 单文件打包** | ❌ 无法访问 | ⚠️ 文件可能过大 | ✅ 无需安装 | ⭐⭐ |

### GitHub Pages 的定位

GitHub Pages 版本只能作为：
- **演示版**：展示游戏界面和功能
- **预览版**：让用户体验游戏玩法
- **模拟模式**：使用前端模拟 AI 回复（已实现）

**不能作为**：
- ❌ 完整功能版（无法与 AI 交互）
- ❌ 生产使用版

---

## 最终推荐

### ✅ 采用双版本策略

1. **GitHub Pages 版本**（展示用）
   - 保持现有实现
   - 添加明显的提示："此为演示版本，完整功能请安装本地版"
   - 提供下载本地版的链接

2. **本地安装版本**（功能完整）
   - 当前已完成的 `villain-game-install/` 包
   - 提供详细的安装文档
   - 这是**唯一能与 AI 实时交互的版本**

### 📝 用户体验优化

在 GitHub Pages 版本的 `game.js` 中添加明显提示：

```javascript
if (typeof TavernHelper === 'undefined') {
    // 显示横幅提示
    this.showBanner(
        '⚠️ 当前为演示版本，AI 交互功能不可用。<br>' +
        '要体验完整功能，请<a href="安装指南链接">安装本地版本</a>。',
        'warning'
    );
}
```

---

## 技术要点总结

### 浏览器同源策略（CORS）

- **定义**：只有协议、域名、端口完全相同的页面才能互相访问
- **限制**：
  - `https://ambroselbt28-gif.github.io` ≠ `http://localhost:8000`
  - iframe 无法访问父窗口的对象（如 `TavernHelper`）
- **绕过方法**：无（这是浏览器的安全机制）

### 可行的架构

```
SillyTavern (localhost:8000)
├── public/
│   └── villain-game/          ← 游戏文件部署在这里
│       ├── index.html         ← 访问路径: /villain-game/index.html
│       ├── game.js            ← 可以访问 parent.TavernHelper
│       └── style.css
└── index.html (主应用)
    └── TavernHelper API       ← 游戏可以访问
```

### 不可行的架构

```
SillyTavern (localhost:8000)
└── iframe src="https://github.io/game"  ← 不同源，无法访问 TavernHelper
```

---

## 行动建议

1. ✅ **保持本地安装版本作为主要分发方式**
2. ✅ **改进安装文档**，让用户更容易理解和操作
3. ✅ **在 GitHub Pages 版本添加明显提示**
4. ⚠️ **不要在 jQuery 加载方法上浪费时间**（无法解决核心问题）

---

生成时间: 2025-01-06
